# 智能体内存

<cite>
**本文档中引用的文件**  
- [01_agent_with_memory.py](file://cookbook/memory/01_agent_with_memory.py)
- [02_agentic_memory.py](file://cookbook/memory/02_agentic_memory.py)
- [03_agents_share_memory.py](file://cookbook/memory/03_agents_share_memory.py)
- [04_custom_memory_manager.py](file://cookbook/memory/04_custom_memory_manager.py)
- [05_multi_user_multi_session_chat.py](file://cookbook/memory/05_multi_user_multi_session_chat.py)
- [06_multi_user_multi_session_chat_concurrent.py](file://cookbook/memory/06_multi_user_multi_session_chat_concurrent.py)
- [07_share_memory_and_history_between_agents.py](file://cookbook/memory/07_share_memory_and_history_between_agents.py)
- [manager.py](file://libs/agno/agno/memory/manager.py)
- [base.py](file://libs/agno/agno/db/base.py)
- [memory.py](file://libs/agno/agno/db/schemas/memory.py)
- [redis.py](file://libs/agno/agno/db/redis/redis.py)
- [postgres.py](file://libs/agno/agno/db/postgres/postgres.py)
- [mongo.py](file://libs/agno/agno/db/mongo/mongo.py)
- [json_for_agent.py](file://cookbook/db/json/json_for_agent.py)
- [redis_for_agent.py](file://cookbook/db/redis/redis_for_agent.py)
- [postgres_for_agent.py](file://cookbook/db/postgres/postgres_for_agent.py)
- [mongodb_for_agent.py](file://cookbook/db/mongo/mongodb_for_agent.py)
</cite>

## 目录
1. [简介](#简介)
2. [内存概念与核心组件](#内存概念与核心组件)
3. [内存管理器配置与持久化存储](#内存管理器配置与持久化存储)
4. [单智能体内存使用](#单智能体内存使用)
5. [多智能体团队内存共享](#多智能体团队内存共享)
6. [多用户多会话场景](#多用户多会话场景)
7. [内存操作：创建、读取、搜索与管理](#内存操作创建读取搜索与管理)
8. [指令控制与高级用法](#指令控制与高级用法)
9. [结论](#结论)

## 简介
智能体内存系统是用于存储与特定用户、会话或智能体相关的动态上下文信息的核心机制。该系统能够持久化保存对话历史、用户偏好、短期状态等关键数据，从而实现跨会话的个性化交互和上下文感知。本文档详细阐述了内存系统的架构、配置方法和使用场景，涵盖从基础配置到高级功能的完整知识体系。

## 内存概念与核心组件
内存（Memory）在智能体系统中指代用于存储用户相关动态信息的数据结构。每个内存条目由`UserMemory`类表示，包含以下核心字段：
- `memory`: 存储的具体记忆内容
- `memory_id`: 记忆的唯一标识符
- `user_id`: 关联的用户ID
- `topics`: 记忆主题标签列表
- `updated_at`: 最后更新时间戳
- `agent_id`/`team_id`: 关联的智能体或团队ID

内存系统通过`MemoryManager`类进行管理，该类负责协调记忆的创建、更新、删除和检索操作。`MemoryManager`与底层数据库交互，实现数据的持久化存储。

**Section sources**
- [memory.py](file://libs/agno/agno/db/schemas/memory.py#L0-L47)
- [manager.py](file://libs/agno/agno/memory/manager.py#L0-L1074)

## 内存管理器配置与持久化存储
内存管理器支持多种后端数据库实现持久化存储，包括Redis、PostgreSQL、MongoDB、SQLite等。配置内存管理器需要指定数据库连接和存储策略。

### 支持的后端存储
- **Redis**: 适用于高性能、低延迟的内存存储场景
- **PostgreSQL**: 提供完整的ACID事务支持，适合复杂查询
- **MongoDB**: 文档型数据库，灵活的模式设计
- **SQLite**: 轻量级嵌入式数据库，适合本地开发
- **JSON文件**: 简单的文件存储方案

### 配置示例
通过配置`db`参数将内存管理器连接到指定的后端存储。例如，使用PostgreSQL作为存储后端：

```python
db = PostgresDb(db_url="postgresql+psycopg://user:pass@localhost:5432/dbname")
agent = Agent(db=db, enable_user_memories=True)
```

**Section sources**
- [redis.py](file://libs/agno/agno/db/redis/redis.py#L84-L119)
- [postgres.py](file://libs/agno/agno/db/postgres/postgres.py)
- [mongo.py](file://libs/agno/agno/db/mongo/mongo.py)
- [json_for_agent.py](file://cookbook/db/json/json_for_agent.py)

## 单智能体内存使用
在单智能体场景中，内存系统用于维护与特定用户的对话上下文和个人信息。通过启用`enable_user_memories`或`enable_agentic_memory`配置，智能体能够自动管理用户记忆。

### 基础记忆功能
当`enable_user_memories=True`时，智能体会自动提取用户对话中的关键信息并创建记忆条目。这些记忆在后续交互中可用于个性化响应。

### 智能记忆管理
启用`enable_agentic_memory=True`后，智能体获得自主决策能力，可以主动创建、更新或删除记忆。这种模式下，智能体基于对话内容判断哪些信息值得记忆，并执行相应的数据库操作。

```mermaid
sequenceDiagram
participant 用户
participant 智能体
participant 内存管理器
participant 数据库
用户->>智能体 : "我叫张三，喜欢爬山"
智能体->>内存管理器 : 分析对话内容
内存管理器->>数据库 : 创建记忆条目
数据库-->>内存管理器 : 确认存储
内存管理器-->>智能体 : 记忆创建成功
智能体-->>用户 : 理解，已记录您的信息
```

**Diagram sources**
- [01_agent_with_memory.py](file://cookbook/memory/01_agent_with_memory.py#L0-L57)
- [02_agentic_memory.py](file://cookbook/memory/02_agentic_memory.py#L0-L67)

**Section sources**
- [01_agent_with_memory.py](file://cookbook/memory/01_agent_with_memory.py#L0-L57)
- [02_agentic_memory.py](file://cookbook/memory/02_agentic_memory.py#L0-L67)

## 多智能体团队内存共享
在多智能体团队场景中，多个智能体可以通过共享同一个数据库实例来访问和操作相同的内存数据。这种架构支持团队协作和信息共享。

### 共享内存架构
多个智能体实例配置相同的数据库连接，从而实现内存数据的共享。当一个智能体更新记忆时，其他智能体可以立即访问最新的信息。

### 协作场景示例
一个聊天智能体和一个研究智能体共享内存系统。聊天智能体记录用户的基本信息，研究智能体利用这些信息提供个性化的研究服务。

```mermaid
graph TD
subgraph "智能体团队"
A[聊天智能体]
B[研究智能体]
end
A --> DB[(共享数据库)]
B --> DB
DB --> 用户记忆
```

**Diagram sources**
- [03_agents_share_memory.py](file://cookbook/memory/03_agents_share_memory.py#L0-L50)

**Section sources**
- [03_agents_share_memory.py](file://cookbook/memory/03_agents_share_memory.py#L0-L50)

## 多用户多会话场景
内存系统支持复杂的多用户多会话场景，能够准确区分不同用户和会话的记忆数据。

### 用户隔离
通过`user_id`字段实现用户间的数据隔离。每个用户的记忆独立存储，确保隐私和数据安全。

### 会话管理
结合`session_id`和`user_id`，系统能够管理同一用户在不同会话中的上下文。这支持跨会话的连续对话体验。

### 并发处理
系统设计支持高并发访问，多个用户可以同时与智能体交互而不互相干扰。

**Section sources**
- [05_multi_user_multi_session_chat.py](file://cookbook/memory/05_multi_user_multi_session_chat.py)
- [06_multi_user_multi_session_chat_concurrent.py](file://cookbook/memory/06_multi_user_multi_session_chat_concurrent.py)

## 内存操作：创建、读取、搜索与管理
内存系统提供完整的CRUD（创建、读取、更新、删除）操作接口。

### 创建记忆
通过`add_user_memory`方法创建新的记忆条目，系统会自动生成唯一ID并记录创建时间。

### 读取记忆
`get_user_memories`方法支持按用户ID检索所有相关记忆，返回结构化的`UserMemory`对象列表。

### 搜索记忆
提供多种检索策略：
- `last_n`: 获取最近的记忆
- `first_n`: 获取最早的记忆
- `agentic`: 基于语义相似度的智能搜索

### 管理操作
支持批量删除、清除所有记忆等管理功能，通过`delete_user_memory`和`clear`方法实现。

```mermaid
flowchart TD
Start([开始]) --> 创建["创建记忆<br/>add_user_memory()"]
创建 --> 读取["读取记忆<br/>get_user_memories()"]
读取 --> 搜索["搜索记忆<br/>search_user_memories()"]
搜索 --> 更新["更新记忆<br/>replace_user_memory()"]
更新 --> 删除["删除记忆<br/>delete_user_memory()"]
删除 --> 结束([结束])
```

**Diagram sources**
- [manager.py](file://libs/agno/agno/memory/manager.py#L0-L1074)

**Section sources**
- [manager.py](file://libs/agno/agno/memory/manager.py#L0-L1074)

## 指令控制与高级用法
内存系统支持通过指令（instructions）精细控制记忆行为，实现高级功能。

### 自定义记忆指令
通过`memory_capture_instructions`参数定义记忆捕获规则，指定哪些类型的信息应该被记忆。

### 内存搜索优化
`search_user_memories`方法支持多种检索方法，包括基于时间顺序的检索和基于语义相似度的智能检索。

### 跨智能体共享
通过配置相同的数据库实例，实现多个智能体之间的记忆共享和协同工作。

### 高级配置选项
- `delete_memories`: 控制是否允许删除记忆
- `clear_memories`: 控制是否允许清除所有记忆
- `update_memories`: 控制是否允许更新现有记忆
- `add_memories`: 控制是否允许添加新记忆

**Section sources**
- [04_custom_memory_manager.py](file://cookbook/memory/04_custom_memory_manager.py)
- [07_share_memory_and_history_between_agents.py](file://cookbook/memory/07_share_memory_and_history_between_agents.py)
- [manager.py](file://libs/agno/agno/memory/manager.py#L0-L1074)

## 结论
智能体内存系统为构建上下文感知的智能体提供了强大的基础支持。通过灵活的存储后端选择、精细的指令控制和丰富的API接口，开发者能够实现从简单记忆到复杂多智能体协作的各种应用场景。该系统的设计兼顾了性能、可扩展性和易用性，是构建高级智能体应用的核心组件。