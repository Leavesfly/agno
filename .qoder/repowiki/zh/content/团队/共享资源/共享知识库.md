# 团队共享知识库

<cite>
**本文档中引用的文件**
- [01_team_with_knowledge.py](file://cookbook/teams/knowledge/01_team_with_knowledge.py)
- [02_team_with_knowledge_filters.py](file://cookbook/teams/knowledge/02_team_with_knowledge_filters.py)
- [03_team_with_agentic_knowledge_filters.py](file://cookbook/teams/knowledge/03_team_with_agentic_knowledge_filters.py)
- [01_from_path.py](file://cookbook/knowledge/basic_operations/01_from_path.py)
- [02_from_url.py](file://cookbook/knowledge/basic_operations/02_from_url.py)
- [03_from_topic.py](file://cookbook/knowledge/basic_operations/03_from_topic.py)
- [04_from_multiple.py](file://cookbook/knowledge/basic_operations/04_from_multiple.py)
- [filtering.py](file://cookbook/knowledge/filters/filtering.py)
- [knowledge_tools.py](file://cookbook/knowledge/knowledge_tools.py)
- [lance_db.py](file://libs/agno/agno/vectordb/lancedb/lance_db.py)
- [openai_embedder.py](file://cookbook/knowledge/embedders/openai_embedder.py)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [基础知识库加载](#基础知识库加载)
4. [团队知识库架构](#团队知识库架构)
5. [详细组件分析](#详细组件分析)
6. [过滤和智能检索](#过滤和智能检索)
7. [向量数据库集成](#向量数据库集成)
8. [性能考虑](#性能考虑)
9. [故障排除指南](#故障排除指南)
10. [结论](#结论)

## 简介

团队共享知识库是一个强大的系统，允许整个团队访问和检索统一的信息源。该系统通过 `01_team_with_knowledge.py` 实现了基础知识库的配置，通过 `02_team_with_knowledge_filters.py` 和 `03_team_with_agentic_knowledge_filters.py` 提供了高级的过滤和智能检索功能。

这个系统的核心价值在于：
- **统一信息源**：所有团队成员访问相同的知识库
- **多源内容整合**：支持从路径、URL、主题等多种来源加载知识
- **智能过滤**：提供包含/排除规则和动态过滤功能
- **增强决策能力**：通过知识库提升团队的问答和决策效率

## 项目结构

```mermaid
graph TB
subgraph "知识库核心模块"
KB[knowledge.knowledge]
KBT[knowledge_tools.py]
KBM[knowledge_tools]
end
subgraph "向量数据库"
LDB[LanceDb]
PGB[PostgreSQL]
QDB[Qdrant]
MDB[Milvus]
end
subgraph "嵌入器"
OAI[OpenAI Embedder]
ST[Sentence Transformer]
HF[HuggingFace]
end
subgraph "过滤器"
FILTER[Filtering]
AGENT[Agentic Filtering]
ASYNC[Async Filtering]
end
subgraph "团队集成"
TEAM[Team]
AGENT2[Agent]
MEMBERS[Team Members]
end
KB --> LDB
KB --> PGB
KB --> QDB
KB --> MDB
KB --> OAI
KB --> ST
KB --> HF
KB --> FILTER
KB --> AGENT
KB --> ASYNC
TEAM --> KB
TEAM --> AGENT2
AGENT2 --> MEMBERS
AGENT2 --> KBT
```

**图表来源**
- [01_team_with_knowledge.py](file://cookbook/teams/knowledge/01_team_with_knowledge.py#L1-L57)
- [lance_db.py](file://libs/agno/agno/vectordb/lancedb/lance_db.py#L1-L100)

## 基础知识库加载

### 路径内容加载

基础知识库的加载通过多种方式实现，首先是本地文件路径的处理：

```python
# 从本地路径加载PDF文件
knowledge.add_content(
    name="CV",
    path="cookbook/knowledge/testing_resources/cv_1.pdf",
    metadata={"user_tag": "Engineering Candidates"}
)
```

这种方式适用于：
- 本地存储的文档
- 需要批量处理的文件集合
- 需要元数据标记的特定内容

### URL内容加载

从网络URL加载内容提供了实时信息获取的能力：

```python
# 从URL加载远程文档
knowledge.add_content(
    name="Recipes",
    url="https://agno-public.s3.amazonaws.com/recipes/ThaiRecipes.pdf",
    metadata={"user_tag": "Recipes from website"}
)
```

支持的URL类型包括：
- PDF文档
- Markdown文件
- 文本文件
- Web页面

### 主题内容加载

通过主题名称自动搜索和加载相关信息：

```python
# 从Wikipedia和Arxiv加载主题内容
knowledge.add_content_async(
    metadata={"user_tag": "Wikipedia content"},
    topics=["Manchester United"],
    reader=WikipediaReader()
)
```

### 多源内容批量加载

同时从多个来源加载内容以构建全面的知识库：

```python
# 批量加载多种类型的资源
knowledge.add_contents_async([
    {
        "name": "CV's",
        "path": "cookbook/knowledge/testing_resources/cv_1.pdf",
        "metadata": {"user_tag": "Engineering candidates"}
    },
    {
        "name": "Docs",
        "url": "https://docs.agno.com/introduction",
        "metadata": {"user_tag": "Documents"}
    }
])
```

**章节来源**
- [01_from_path.py](file://cookbook/knowledge/basic_operations/01_from_path.py#L1-L48)
- [02_from_url.py](file://cookbook/knowledge/basic_operations/02_from_url.py#L1-L48)
- [03_from_topic.py](file://cookbook/knowledge/basic_operations/03_from_topic.py#L1-L42)
- [04_from_multiple.py](file://cookbook/knowledge/basic_operations/04_from_multiple.py#L1-L52)

## 团队知识库架构

### 基础团队知识库

```mermaid
classDiagram
class Team {
+string name
+list members
+Knowledge knowledge
+Model model
+bool show_members_responses
+bool markdown
+search_knowledge(query) Response
+print_response(query) void
}
class Knowledge {
+string name
+string description
+VectorDb vector_db
+ContentDb contents_db
+add_content(path) void
+add_content(url) void
+search(query) Document[]
+remove_vectors_by_name(name) void
}
class Agent {
+string name
+string role
+Knowledge knowledge
+Model model
+Tool[] tools
+search_knowledge(query) Response
}
class LanceDb {
+string uri
+string table_name
+SearchType search_type
+Embedder embedder
+insert(documents) void
+search(query) Document[]
+vector_search(query) Document[]
}
Team --> Knowledge : "uses"
Team --> Agent : "contains"
Agent --> Knowledge : "searches"
Knowledge --> LanceDb : "stores in"
```

**图表来源**
- [01_team_with_knowledge.py](file://cookbook/teams/knowledge/01_team_with_knowledge.py#L1-L57)
- [lance_db.py](file://libs/agno/agno/vectordb/lancedb/lance_db.py#L20-L100)

### 核心架构组件

基础团队知识库的实现展示了完整的架构模式：

```python
# 初始化知识库
agno_docs_knowledge = Knowledge(
    vector_db=LanceDb(
        uri=str(tmp_dir.joinpath("lancedb")),
        table_name="agno_docs",
        search_type=SearchType.hybrid,
        embedder=OpenAIEmbedder(id="text-embedding-3-small"),
    ),
)

# 添加内容到知识库
agno_docs_knowledge.add_content(url="https://docs.agno.com/llms-full.txt")

# 创建具有知识库集成的团队
team_with_knowledge = Team(
    name="Team with Knowledge",
    members=[web_agent],
    model=OpenAIChat(id="o3-mini"),
    knowledge=agno_docs_knowledge,
    show_members_responses=True,
    markdown=True,
)
```

这种架构的优势包括：
- **模块化设计**：每个组件职责明确
- **可扩展性**：易于添加新的向量数据库或嵌入器
- **一致性**：所有团队成员使用相同的知识库

**章节来源**
- [01_team_with_knowledge.py](file://cookbook/teams/knowledge/01_team_with_knowledge.py#L1-L57)

## 详细组件分析

### 知识库工具集成

知识库工具提供了强大的推理能力，允许代理从知识库中搜索和分析信息：

```mermaid
sequenceDiagram
participant Agent as "AI Agent"
participant Tools as "Knowledge Tools"
participant KB as "Knowledge Base"
participant VDB as "Vector Database"
participant Embedder as "Embedder"
Agent->>Tools : search_query("How do I build a team?")
Tools->>KB : process_query(query)
KB->>VDB : vector_search(embedded_query)
VDB->>Embedder : get_embedding(query)
Embedder-->>VDB : embedding_vector
VDB-->>KB : search_results
KB->>KB : rerank_results(query, results)
KB-->>Tools : filtered_documents
Tools->>Tools : analyze_documents(documents)
Tools-->>Agent : structured_response
```

**图表来源**
- [knowledge_tools.py](file://cookbook/knowledge/knowledge_tools.py#L1-L49)

### 向量数据库实现

LanceDB作为向量数据库的核心实现，提供了高性能的向量搜索功能：

```python
class LanceDb(VectorDb):
    def __init__(self, uri="/tmp/lancedb", table_name=None, 
                 search_type=SearchType.vector, distance=Distance.cosine):
        self.uri = uri
        self.table_name = table_name
        self.search_type = search_type
        self.distance = distance
        
    def insert(self, content_hash, documents, filters=None):
        # 准备向量数据
        data = []
        for document in documents:
            document.embed(embedder=self.embedder)
            payload = {
                "name": document.name,
                "meta_data": document.meta_data,
                "content": document.content,
                "usage": document.usage
            }
            data.append({
                "id": doc_id,
                "vector": self._prepare_vector(document.embedding),
                "payload": json.dumps(payload)
            })
        
        # 插入到LanceDB表
        self.table.add(data)
```

关键特性：
- **混合搜索**：支持向量、关键词和混合搜索模式
- **异步操作**：支持异步插入和搜索
- **元数据过滤**：支持基于元数据的精确过滤
- **向量优化**：支持nprobes参数进行性能调优

### 嵌入器配置

嵌入器负责将文本转换为向量表示：

```python
# OpenAI嵌入器配置
embedder = OpenAIEmbedder(
    id="text-embedding-3-small",
    dimensions=1536
)

# 使用自定义嵌入器
knowledge = Knowledge(
    vector_db=PgVector(
        table_name="vectors",
        db_url="postgresql://user:pass@localhost/db",
        embedder=embedder
    )
)
```

支持的嵌入器类型：
- OpenAI嵌入器
- Sentence Transformer
- HuggingFace模型
- 自定义嵌入器

**章节来源**
- [lance_db.py](file://libs/agno/agno/vectordb/lancedb/lance_db.py#L1-L1016)
- [openai_embedder.py](file://cookbook/knowledge/embedders/openai_embedder.py#L1-L22)

## 过滤和智能检索

### 静态过滤器

静态过滤器允许预先定义过滤条件，限制搜索范围：

```python
# 创建带有过滤器的团队
team_with_knowledge = Team(
    name="Team with Knowledge",
    members=[web_agent],
    knowledge=knowledge_base,
    show_members_responses=True,
    markdown=True,
    knowledge_filters={
        "user_id": "jordan_mitchell"
    }
)
```

过滤器的工作原理：

```mermaid
flowchart TD
Query["用户查询"] --> Parse["解析查询内容"]
Parse --> Extract["提取过滤条件"]
Extract --> Apply["应用过滤器"]
Apply --> Search["向量搜索"]
Search --> Filter["元数据过滤"]
Filter --> Rank["结果排序"]
Rank --> Return["返回结果"]
Extract --> Manual["手动指定<br/>user_id: jordan_mitchell"]
Extract --> Auto["自动识别<br/>从查询中提取"]
```

**图表来源**
- [02_team_with_knowledge_filters.py](file://cookbook/teams/knowledge/02_team_with_knowledge_filters.py#L1-L110)

### 智能过滤器

智能过滤器允许AI动态决定搜索范围：

```python
# 启用智能过滤的团队
team_with_knowledge = Team(
    name="Team with Knowledge",
    members=[web_agent],
    knowledge=knowledge,
    enable_agentic_knowledge_filters=True,
    show_members_responses=True,
    markdown=True
)

# 查询时包含过滤指示
response = team_with_knowledge.print_response(
    "Tell me about Jordan Mitchell's work and experience with user_id as jordan_mitchell"
)
```

智能过滤的优势：
- **上下文感知**：根据查询内容自动选择相关文档
- **动态调整**：无需预定义过滤规则
- **自然语言交互**：支持自然语言描述过滤条件

### 元数据管理

知识库中的每个文档都包含丰富的元数据：

```python
# 添加带元数据的文档
knowledge.add_contents([
    {
        "path": downloaded_cv_paths[0],
        "metadata": {
            "user_id": "jordan_mitchell",
            "document_type": "cv",
            "year": 2025,
            "department": "engineering",
            "position": "senior_developer"
        }
    }
])

# 支持的元数据字段
supported_metadata = {
    "user_id": "唯一标识符",
    "document_type": "文档类型（cv、report、article等）",
    "year": "年份信息",
    "department": "部门信息",
    "position": "职位信息",
    "tags": "标签列表",
    "source": "来源标识"
}
```

**章节来源**
- [02_team_with_knowledge_filters.py](file://cookbook/teams/knowledge/02_team_with_knowledge_filters.py#L1-L110)
- [03_team_with_agentic_knowledge_filters.py](file://cookbook/teams/knowledge/03_team_with_agentic_knowledge_filters.py#L1-L107)
- [filtering.py](file://cookbook/knowledge/filters/filtering.py#L1-L84)

## 向量数据库集成

### 支持的向量数据库

系统支持多种向量数据库，每种都有其特定优势：

```mermaid
graph LR
subgraph "云原生数据库"
LDB[LanceDB]
QDB[Qdrant]
WDB[Weaviate]
end
subgraph "关系型数据库"
PGB[PostgreSQL + pgvector]
MGB[MongoDB Atlas Vector Search]
end
subgraph "专用向量数据库"
MD[Milvus]
PD[Pinecone]
UD[Upstash Redis]
end
subgraph "本地数据库"
CDB[Cassandra]
SDB[SingleStore]
RDB[Redis]
end
KB[Knowledge Base] --> LDB
KB --> QDB
KB --> WDB
KB --> PGB
KB --> MGB
KB --> MD
KB --> PD
KB --> UD
KB --> CDB
KB --> SDB
KB --> RDB
```

### LanceDB深度集成

LanceDB是系统的主要向量数据库实现：

```python
# LanceDB配置示例
vector_db = LanceDb(
    table_name="recipes",
    uri="tmp/lancedb",
    search_type=SearchType.hybrid,
    embedder=OpenAIEmbedder(id="text-embedding-3-small"),
    use_tantivy=True,
    nprobes=20
)

# 混合搜索实现
def hybrid_search(self, query: str, limit: int = 5):
    # 获取向量嵌入
    query_embedding = self.embedder.get_embedding(query)
    
    # 创建全文索引（如果不存在）
    if not self.fts_index_exists:
        self.table.create_fts_index("payload", use_tantivy=self.use_tantivy, replace=True)
        self.fts_index_exists = True
    
    # 执行混合搜索
    results = (
        self.table.search(vector_column_name=self._vector_col, query_type="hybrid")
        .vector(query_embedding)
        .text(query)
        .limit(limit)
    )
    
    return results.to_pandas()
```

### 异步操作支持

系统全面支持异步操作以提高性能：

```python
# 异步知识库操作
async def async_knowledge_operations():
    # 异步添加内容
    await knowledge.add_content_async(
        name="New Document",
        path="path/to/document.pdf"
    )
    
    # 异步搜索
    results = await knowledge.search_async(
        query="search query",
        limit=10
    )
    
    # 异步删除
    await knowledge.remove_vectors_by_name_async("Old Document")
```

**章节来源**
- [lance_db.py](file://libs/agno/agno/vectordb/lancedb/lance_db.py#L1-L1016)

## 性能考虑

### 向量搜索优化

为了获得最佳性能，需要考虑以下因素：

1. **nprobes参数调优**
   ```python
   # 高精度搜索（较慢但准确）
   vector_db = LanceDb(nprobes=100)
   
   # 平衡性能和精度
   vector_db = LanceDb(nprobes=20)
   
   # 快速搜索（可能不准确）
   vector_db = LanceDb(nprobes=5)
   ```

2. **搜索类型选择**
   - **向量搜索**：适合语义相似度匹配
   - **关键词搜索**：适合精确匹配
   - **混合搜索**：结合两者优势

3. **内存管理**
   ```python
   # 定期清理旧内容
   knowledge.remove_vectors_by_name("Old Document")
   
   # 限制最大结果数
   knowledge = Knowledge(max_results=10)
   ```

### 扩展性策略

对于大型团队和大量文档：

1. **分片存储**：按部门或项目分组存储
2. **缓存机制**：缓存频繁查询的结果
3. **增量更新**：只更新变化的内容
4. **负载均衡**：在多个向量数据库间分配负载

## 故障排除指南

### 常见问题和解决方案

1. **向量维度不匹配**
   ```
   错误：ValueError: Embedder.dimensions must be set.
   解决：确保嵌入器正确初始化并设置维度
   ```

2. **连接超时**
   ```
   错误：Connection timeout to vector database
   解决：检查网络连接，增加超时时间，或使用本地数据库
   ```

3. **内存不足**
   ```
   错误：Out of memory during embedding
   解决：减少批处理大小，使用更小的嵌入模型
   ```

4. **权限问题**
   ```
   错误：Permission denied to access vector database
   解决：检查数据库连接凭据和权限设置
   ```

### 调试技巧

```python
# 启用调试模式
agent = Agent(
    knowledge=knowledge,
    debug_mode=True,
    search_knowledge=True
)

# 检查知识库状态
print(f"Knowledge base contains {knowledge.get_count()} documents")
print(f"Vector database dimensions: {vector_db.dimensions}")

# 测试单个文档
test_document = Document(content="Test content")
embedding = embedder.get_embedding(test_document.content)
print(f"Generated embedding with {len(embedding)} dimensions")
```

**章节来源**
- [lance_db.py](file://libs/agno/agno/vectordb/lancedb/lance_db.py#L1-L1016)

## 结论

团队共享知识库系统提供了一个强大而灵活的平台，用于构建和维护统一的知识库。通过 `01_team_with_knowledge.py` 的基础实现，`02_team_with_knowledge_filters.py` 的静态过滤功能，以及 `03_team_with_agentic_knowledge_filters.py` 的智能过滤能力，该系统能够满足各种规模团队的需求。

### 主要优势

1. **统一访问**：所有团队成员访问相同的信息源
2. **多源整合**：支持从不同来源加载和整合知识
3. **智能过滤**：提供静态和动态过滤选项
4. **高性能**：基于向量数据库的快速搜索
5. **可扩展**：支持多种向量数据库和嵌入器

### 最佳实践建议

1. **合理规划内容组织**：按主题或部门组织知识库内容
2. **定期维护**：清理过时内容，更新嵌入器配置
3. **监控性能**：定期检查搜索性能和资源使用情况
4. **安全考虑**：实施适当的访问控制和数据保护措施

通过遵循这些指导原则和最佳实践，团队可以充分利用共享知识库系统，显著提升协作效率和决策质量。