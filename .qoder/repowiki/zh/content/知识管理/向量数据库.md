# 向量数据库

<cite>
**本文档引用的文件**
- [base.py](file://libs/agno/agno/vectordb/base.py)
- [pgvector.py](file://libs/agno/agno/vectordb/pgvector/pgvector.py)
- [lance_db.py](file://libs/agno/agno/vectordb/lancedb/lance_db.py)
- [qdrant.py](file://libs/agno/agno/vectordb/qdrant/qdrant.py)
- [index.py](file://libs/agno/agno/vectordb/pgvector/index.py)
- [distance.py](file://libs/agno/agno/vectordb/distance.py)
- [search.py](file://libs/agno/agno/vectordb/search.py)
- [README.md](file://cookbook/knowledge/vector_db/README.md)
- [agentic_rag_pgvector.py](file://cookbook/agents/rag/agentic_rag_pgvector.py)
- [agentic_rag_lancedb.py](file://cookbook/agents/rag/agentic_rag_lancedb.py)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概览](#架构概览)
5. [详细组件分析](#详细组件分析)
6. [依赖关系分析](#依赖关系分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介

Agno 支持多种向量数据库后端，为知识库提供了强大的向量存储和检索能力。该系统设计了统一的 `VectorDb` 抽象层，使得用户可以在不同的向量数据库之间无缝切换，包括 PostgreSQL + PgVector、LanceDB、Qdrant、Chroma、Milvus、Weaviate、SingleStore 等。

向量数据库是现代知识检索系统的核心组件，它们能够存储嵌入向量并执行相似性搜索，这对于语义搜索、推荐系统和智能问答至关重要。

## 项目结构

向量数据库模块位于 `libs/agno/agno/vectordb/` 目录下，采用模块化设计，每个向量数据库都有独立的实现：

```mermaid
graph TB
subgraph "向量数据库模块"
Base[base.py<br/>基础抽象类]
Dist[distance.py<br/>距离度量]
Search[search.py<br/>搜索类型]
subgraph "具体实现"
PgVector[pgvector/<br/>PostgreSQL + PgVector]
LanceDB[lancedb/<br/>LanceDB]
Qdrant[qdrant/<br/>Qdrant]
Chroma[chroma/<br/>ChromaDB]
Milvus[milvus/<br/>Milvus]
Weaviate[weaviate/<br/>Weaviate]
SingleStore[singlestore/<br/>SingleStore]
end
subgraph "索引与优化"
PgIndex[pgvector/index.py<br/>PgVector索引]
end
end
Base --> PgVector
Base --> LanceDB
Base --> Qdrant
Base --> Chroma
Base --> Milvus
Base --> Weaviate
Base --> SingleStore
Dist --> PgVector
Dist --> LanceDB
Dist --> Qdrant
Search --> PgVector
Search --> LanceDB
Search --> Qdrant
PgIndex --> PgVector
```

**图表来源**
- [base.py](file://libs/agno/agno/vectordb/base.py#L1-L109)
- [pgvector.py](file://libs/agno/agno/vectordb/pgvector/pgvector.py#L1-L50)
- [lance_db.py](file://libs/agno/agno/vectordb/lancedb/lance_db.py#L1-L50)

**章节来源**
- [base.py](file://libs/agno/agno/vectordb/base.py#L1-L109)
- [README.md](file://cookbook/knowledge/vector_db/README.md#L1-L49)

## 核心组件

### VectorDb 基础抽象类

所有向量数据库实现都继承自 `VectorDb` 抽象基类，该类定义了统一的操作接口：

```python
class VectorDb(ABC):
    """向量数据库基础类"""
    
    @abstractmethod
    def create(self) -> None:
        """创建数据库表/集合"""
        raise NotImplementedError

    @abstractmethod
    async def async_create(self) -> None:
        """异步创建数据库表/集合"""
        raise NotImplementedError

    @abstractmethod
    def insert(self, content_hash: str, documents: List[Document], filters: Optional[Dict[str, Any]] = None) -> None:
        """插入文档"""
        raise NotImplementedError

    @abstractmethod
    async def async_insert(self, content_hash: str, documents: List[Document], filters: Optional[Dict[str, Any]] = None) -> None:
        """异步插入文档"""
        raise NotImplementedError

    @abstractmethod
    def search(self, query: str, limit: int = 5, filters: Optional[Dict[str, Any]] = None) -> List[Document]:
        """搜索文档"""
        raise NotImplementedError

    @abstractmethod
    async def async_search(self, query: str, limit: int = 5, filters: Optional[Dict[str, Any]] = None) -> List[Document]:
        """异步搜索文档"""
        raise NotImplementedError
```

### 距离度量系统

系统支持三种主要的距离度量方法：

```python
class Distance(str, Enum):
    cosine = "cosine"           # 余弦距离
    l2 = "l2"                   # 欧几里得距离
    max_inner_product = "max_inner_product"  # 最大内积
```

### 搜索类型系统

支持三种搜索模式：

```python
class SearchType(str, Enum):
    vector = "vector"           # 向量搜索
    keyword = "keyword"         # 关键词搜索
    hybrid = "hybrid"           # 混合搜索
```

**章节来源**
- [base.py](file://libs/agno/agno/vectordb/base.py#L1-L109)
- [distance.py](file://libs/agno/agno/vectordb/distance.py#L1-L8)
- [search.py](file://libs/agno/agno/vectordb/search.py#L1-L8)

## 架构概览

向量数据库系统采用分层架构设计，确保了良好的可扩展性和维护性：

```mermaid
graph TB
subgraph "应用层"
Agent[智能代理]
Workflow[工作流]
Team[团队协作]
end
subgraph "知识层"
Knowledge[知识库]
Embedder[嵌入器]
Reranker[重排序器]
end
subgraph "向量数据库层"
VectorDB[VectorDb抽象层]
subgraph "具体实现"
PgVectorImpl[PgVector实现]
LanceDBImpl[LanceDB实现]
QdrantImpl[Qdrant实现]
OtherImpl[其他实现...]
end
end
subgraph "存储层"
PostgreSQL[(PostgreSQL<br/>+ pgvector)]
LocalFile[本地文件系统]
RemoteServer[远程服务器]
CloudStorage[云存储]
end
Agent --> Knowledge
Workflow --> Knowledge
Team --> Knowledge
Knowledge --> Embedder
Knowledge --> Reranker
Knowledge --> VectorDB
VectorDB --> PgVectorImpl
VectorDB --> LanceDBImpl
VectorDB --> QdrantImpl
VectorDB --> OtherImpl
PgVectorImpl --> PostgreSQL
LanceDBImpl --> LocalFile
QdrantImpl --> RemoteServer
OtherImpl --> CloudStorage
```

**图表来源**
- [base.py](file://libs/agno/agno/vectordb/base.py#L5-L109)
- [pgvector.py](file://libs/agno/agno/vectordb/pgvector/pgvector.py#L25-L100)

## 详细组件分析

### PgVector 实现

PgVector 是最成熟的向量数据库实现之一，基于 PostgreSQL 和 pgvector 扩展：

#### 核心特性

```mermaid
classDiagram
class PgVector {
+string table_name
+string schema
+Engine db_engine
+Embedder embedder
+SearchType search_type
+Distance distance
+Ivfflat/HNSW vector_index
+create() void
+async_create() void
+insert(content_hash, documents) void
+async_insert(content_hash, documents) void
+vector_search(query, limit) Document[]
+keyword_search(query, limit) Document[]
+hybrid_search(query, limit) Document[]
+optimize() void
}
class Ivfflat {
+int lists
+int probes
+bool dynamic_lists
+Dict configuration
}
class HNSW {
+int m
+int ef_search
+int ef_construction
+Dict configuration
}
PgVector --> Ivfflat : "使用"
PgVector --> HNSW : "使用"
```

**图表来源**
- [pgvector.py](file://libs/agno/agno/vectordb/pgvector/pgvector.py#L25-L150)
- [index.py](file://libs/agno/agno/vectordb/pgvector/index.py#L1-L24)

#### 配置示例

```python
from agno.vectordb.pgvector import PgVector, SearchType
from agno.knowledge.embedder.openai import OpenAIEmbedder

vector_db = PgVector(
    table_name="vectors",
    db_url="postgresql://user:password@localhost:5432/database",
    search_type=SearchType.hybrid,
    embedder=OpenAIEmbedder(),
    vector_index=HNSW(ef_search=50),
    distance=Distance.cosine
)
```

#### 异步操作支持

PgVector 提供完整的异步操作支持：

```python
# 异步创建表
await vector_db.async_create()

# 异步插入文档
await vector_db.async_insert(content_hash, documents)

# 异步搜索
results = await vector_db.async_search("查询文本", limit=10)
```

**章节来源**
- [pgvector.py](file://libs/agno/agno/vectordb/pgvector/pgvector.py#L25-L200)

### LanceDB 实现

LanceDB 是一个现代化的列式向量数据库，专为高性能向量搜索设计：

#### 核心特性

```mermaid
sequenceDiagram
participant Client as 客户端
participant LanceDB as LanceDB实例
participant Table as 表对象
participant Embedder as 嵌入器
Client->>LanceDB : 创建实例
LanceDB->>LanceDB : 初始化连接
Client->>LanceDB : async_insert(documents)
LanceDB->>Embedder : 获取嵌入向量
Embedder-->>LanceDB : 返回向量
LanceDB->>Table : 添加数据
Table-->>LanceDB : 插入确认
LanceDB-->>Client : 插入完成
Client->>LanceDB : async_search(query)
LanceDB->>LanceDB : 向量搜索
LanceDB-->>Client : 返回结果
```

**图表来源**
- [lance_db.py](file://libs/agno/agno/vectordb/lancedb/lance_db.py#L200-L400)

#### 高级功能

LanceDB 支持以下高级功能：

1. **混合搜索**：结合向量搜索和关键词搜索
2. **全文搜索**：使用 Tantivy 进行全文索引
3. **异步操作**：完整的异步 API 支持
4. **远程连接**：支持云端 LanceDB 实例

```python
from agno.vectordb.lancedb import LanceDb, SearchType

vector_db = LanceDb(
    uri="/path/to/lancedb",
    table_name="documents",
    search_type=SearchType.hybrid,
    use_tantivy=True
)
```

**章节来源**
- [lance_db.py](file://libs/agno/agno/vectordb/lancedb/lance_db.py#L25-L200)

### Qdrant 实现

Qdrant 是一个高性能的向量搜索引擎，支持多种搜索模式：

#### 多模态搜索

```mermaid
flowchart TD
Query[查询请求] --> SearchType{搜索类型}
SearchType --> |向量搜索| VectorSearch[向量相似度搜索]
SearchType --> |关键词搜索| KeywordSearch[关键词搜索]
SearchType --> |混合搜索| HybridSearch[混合搜索]
VectorSearch --> DenseVector[稠密向量搜索]
KeywordSearch --> SparseVector[稀疏向量搜索]
HybridSearch --> Fusion[融合策略]
DenseVector --> Result[搜索结果]
SparseVector --> Result
Fusion --> Result
Result --> Rerank{是否需要重排序}
Rerank --> |是| Reranker[重排序器]
Rerank --> |否| FinalResult[最终结果]
Reranker --> FinalResult
```

**图表来源**
- [qdrant.py](file://libs/agno/agno/vectordb/qdrant/qdrant.py#L400-L600)

#### 配置选项

```python
from agno.vectordb.qdrant import Qdrant, SearchType

vector_db = Qdrant(
    collection="my_collection",
    search_type=SearchType.hybrid,
    hybrid_fusion_strategy=models.Fusion.RRF,
    dense_vector_name="dense_vector",
    sparse_vector_name="sparse_vector"
)
```

**章节来源**
- [qdrant.py](file://libs/agno/agno/vectordb/qdrant/qdrant.py#L25-L200)

### 其他支持的数据库

系统还支持多种其他向量数据库：

| 数据库 | 特点 | 适用场景 |
|--------|------|----------|
| ChromaDB | 嵌入式数据库 | 开发和测试 |
| Milvus | 分布式向量数据库 | 大规模生产环境 |
| Weaviate | 多模态向量数据库 | 复杂查询场景 |
| SingleStore | 分布式数据库 | 高并发场景 |
| Cassandra | 分布式数据库 | 全局部署 |

**章节来源**
- [README.md](file://cookbook/knowledge/vector_db/README.md#L10-L49)

## 依赖关系分析

向量数据库系统的依赖关系如下：

```mermaid
graph LR
subgraph "外部依赖"
SQLAlchemy[sqlalchemy]
PgVectorExt[pgvector]
LanceDB[lancedb]
QdrantClient[qdrant-client]
FastEmbed[fastembed]
end
subgraph "内部模块"
Base[VectorDb基类]
Embedder[嵌入器]
Document[文档模型]
Knowledge[知识库]
end
subgraph "具体实现"
PgVectorImpl[PgVector]
LanceDBImpl[LanceDB]
QdrantImpl[Qdrant]
end
PgVectorImpl --> SQLAlchemy
PgVectorImpl --> PgVectorExt
LanceDBImpl --> LanceDB
QdrantImpl --> QdrantClient
QdrantImpl --> FastEmbed
Base --> Embedder
Base --> Document
Knowledge --> Base
```

**图表来源**
- [pgvector.py](file://libs/agno/agno/vectordb/pgvector/pgvector.py#L1-L20)
- [lance_db.py](file://libs/agno/agno/vectordb/lancedb/lance_db.py#L1-L20)
- [qdrant.py](file://libs/agno/agno/vectordb/qdrant/qdrant.py#L1-L20)

**章节来源**
- [pgvector.py](file://libs/agno/agno/vectordb/pgvector/pgvector.py#L1-L30)
- [lance_db.py](file://libs/agno/agno/vectordb/lancedb/lance_db.py#L1-L30)
- [qdrant.py](file://libs/agno/agno/vectordb/qdrant/qdrant.py#L1-L30)

## 性能考虑

### 索引优化

不同数据库有不同的索引优化策略：

#### PgVector 索引配置

```python
# IVFFlat 索引 - 适合大规模数据集
ivfflat_index = Ivfflat(
    lists=100,           # 聚类数量
    probes=10,           # 查询时检查的聚类数
    dynamic_lists=True   # 动态调整列表大小
)

# HNSW 索引 - 适合高精度搜索
hnsw_index = HNSW(
    m=16,                # 每个节点的最大连接数
    ef_search=50,        # 搜索时检查的节点数
    ef_construction=200  # 构建时检查的节点数
)
```

#### 搜索性能调优

1. **批量处理**：使用批量插入提高吞吐量
2. **异步操作**：利用异步 API 减少等待时间
3. **缓存策略**：缓存频繁查询的结果
4. **索引选择**：根据数据特征选择合适的索引类型

### 内存管理

```python
# 批量大小配置
batch_size = 100  # 根据内存大小调整

# 连接池配置
engine = create_engine(db_url, pool_size=10, max_overflow=20)
```

## 故障排除指南

### 常见问题及解决方案

#### 1. 连接问题

```python
# 检查数据库连接
try:
    vector_db.create()
except Exception as e:
    print(f"连接失败: {e}")
    # 检查数据库URL、凭据和网络连接
```

#### 2. 向量维度不匹配

```python
# 确保嵌入器维度与数据库一致
print(f"嵌入器维度: {embedder.dimensions}")
print(f"数据库期望维度: {vector_db.dimensions}")
```

#### 3. 性能问题

```python
# 启用查询日志
import logging
logging.getLogger('sqlalchemy.engine').setLevel(logging.INFO)

# 使用适当的批量大小
vector_db.insert(content_hash, documents, batch_size=50)
```

**章节来源**
- [pgvector.py](file://libs/agno/agno/vectordb/pgvector/pgvector.py#L100-L200)

## 结论

Agno 的向量数据库系统提供了强大而灵活的知识存储和检索能力。通过统一的抽象层设计，用户可以轻松地在不同的向量数据库之间切换，同时享受各自数据库的独特优势。

### 主要优势

1. **统一接口**：所有数据库实现遵循相同的接口规范
2. **异步支持**：完整的异步操作支持，提升应用性能
3. **多模态搜索**：支持向量、关键词和混合搜索模式
4. **可扩展性**：模块化设计便于添加新的数据库支持
5. **生产就绪**：经过充分测试，适用于各种生产环境

### 最佳实践

1. **选择合适的数据库**：根据数据规模和查询需求选择最适合的数据库
2. **合理配置索引**：根据数据特征和查询模式优化索引配置
3. **监控性能**：定期监控数据库性能指标，及时发现和解决问题
4. **备份策略**：建立完善的备份和恢复机制

通过本文档的指导，开发者可以充分利用 Agno 向量数据库系统的强大功能，构建高效的知识检索和智能问答系统。