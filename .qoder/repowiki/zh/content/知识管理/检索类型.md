# 检索类型

<cite>
**本文档中引用的文件**  
- [hybrid_search.py](file://cookbook/knowledge/search_type/hybrid_search.py)
- [keyword_search.py](file://cookbook/knowledge/search_type/keyword_search.py)
- [vector_search.py](file://cookbook/knowledge/search_type/vector_search.py)
- [README.md](file://cookbook/knowledge/search_type/README.md)
- [pgvector.py](file://libs/agno/agno/vectordb/pgvector/pgvector.py)
- [search.py](file://libs/agno/agno/vectordb/search.py)
- [filtering.py](file://cookbook/knowledge/filters/filtering.py)
- [README.md](file://cookbook/knowledge/filters/README.md)
- [types.py](file://libs/agno/agno/knowledge/types.py)
</cite>

## 目录
1. [简介](#简介)
2. [核心检索模式](#核心检索模式)
3. [向量搜索](#向量搜索)
4. [关键词搜索](#关键词搜索)
5. [混合搜索](#混合搜索)
6. [过滤器应用](#过滤器应用)
7. [智能体中的RAG实现](#智能体中的rag实现)
8. [总结](#总结)

## 简介
Agno 支持三种核心检索模式：向量搜索（语义搜索）、关键词搜索（全文搜索）和混合搜索。这些模式为智能体提供了灵活的信息检索能力，可以根据不同场景选择最合适的搜索策略。本文档详细解释每种模式的技术原理、优势和局限性，并说明如何配置和执行搜索查询，重点介绍混合搜索的实现以及如何在检索过程中应用过滤器。

## 核心检索模式
Agno 的检索系统基于 `SearchType` 枚举类实现，支持三种主要的搜索类型：

- **向量搜索 (vector)**：基于语义相似性的搜索
- **关键词搜索 (keyword)**：基于文本匹配的传统搜索
- **混合搜索 (hybrid)**：结合向量和关键词搜索的综合方法

这些搜索类型通过向量数据库（如 PgVector）进行集成，控制检索行为以适应不同的应用场景。

**Section sources**
- [search.py](file://libs/agno/agno/vectordb/search.py#L0-L6)
- [README.md](file://cookbook/knowledge/search_type/README.md#L31-L36)

## 向量搜索
向量搜索是一种语义搜索技术，通过将查询和文档转换为高维向量空间中的嵌入表示，然后计算它们之间的相似度来进行检索。

### 技术原理
向量搜索使用嵌入模型（如 OpenAIEmbedder）将文本转换为数值向量。搜索时，系统计算查询向量与数据库中所有文档向量之间的距离（支持余弦距离、L2距离等），并按相似度排序返回结果。

### 配置与执行
```python
from agno.knowledge.knowledge import Knowledge
from agno.vectordb.pgvector import PgVector, SearchType

# 创建使用向量搜索的知识库
vector_db = PgVector(
    table_name="recipes", 
    db_url=db_url, 
    search_type=SearchType.vector
)
knowledge = Knowledge(
    name="向量搜索知识库",
    vector_db=vector_db,
)

# 执行向量搜索查询
results = vector_db.search("chicken coconut soup", limit=5)
```

### 优势与局限性
- **优势**：能够理解语义相似性，支持同义词和概念匹配
- **局限性**：对精确术语匹配不够敏感，可能错过字面匹配的内容

**Section sources**
- [vector_search.py](file://cookbook/knowledge/search_type/vector_search.py#L0-L21)
- [pgvector.py](file://libs/agno/agno/vectordb/pgvector/pgvector.py#L500-L550)

## 关键词搜索
关键词搜索是一种传统的全文搜索方法，基于文本中的字面匹配来查找相关文档。

### 技术原理
关键词搜索使用 PostgreSQL 的全文搜索功能（`to_tsvector` 和 `websearch_to_tsquery`），通过计算文本相关性排名（`ts_rank_cd`）来确定匹配程度。支持前缀匹配和多种语言的文本处理。

### 配置与执行
```python
from agno.knowledge.knowledge import Knowledge
from agno.vectordb.pgvector import PgVector, SearchType

# 创建使用关键词搜索的知识库
keyword_db = PgVector(
    table_name="recipes", 
    db_url=db_url, 
    search_type=SearchType.keyword
)
knowledge = Knowledge(
    name="关键词搜索知识库",
    vector_db=keyword_db,
)

# 执行关键词搜索查询
results = keyword_db.search("chicken coconut soup", limit=5)
```

### 优势与局限性
- **优势**：精确匹配关键词，适合查找特定术语或短语
- **局限性**：无法理解语义相似性，难以处理同义词或相关概念

**Section sources**
- [keyword_search.py](file://cookbook/knowledge/search_type/keyword_search.py#L0-L22)
- [pgvector.py](file://libs/agno/agno/vectordb/pgvector/pgvector.py#L600-L650)

## 混合搜索
混合搜索结合了向量搜索和关键词搜索的优势，通过加权组合两种方法的得分来获得更准确、更全面的检索效果。

### 技术原理
混合搜索同时计算向量相似度得分和文本相关性排名，然后根据权重参数（`vector_score_weight`）进行线性组合：

```
混合得分 = (向量权重 × 向量得分) + (文本权重 × 文本排名)
```

其中向量权重由 `vector_score_weight` 参数控制（默认值为 0.5），文本权重为 `1 - vector_score_weight`。

### 配置与执行
```python
from agno.knowledge.knowledge import Knowledge
from agno.vectordb.pgvector import PgVector, SearchType

# 创建使用混合搜索的知识库
hybrid_db = PgVector(
    table_name="recipes", 
    db_url=db_url, 
    search_type=SearchType.hybrid,
    vector_score_weight=0.6  # 向量搜索权重
)
knowledge = Knowledge(
    name="混合搜索知识库",
    vector_db=hybrid_db,
)

# 执行混合搜索查询
results = hybrid_db.search("chicken coconut soup", limit=5)
```

### 优势与局限性
- **优势**：结合语义理解和精确匹配，提高检索准确率
- **局限性**：需要调优权重参数，计算复杂度较高

**Section sources**
- [hybrid_search.py](file://cookbook/knowledge/search_type/hybrid_search.py#L0-L20)
- [pgvector.py](file://libs/agno/agno/vectordb/pgvector/pgvector.py#L700-L750)

## 过滤器应用
过滤器允许在检索过程中基于元数据或其他条件缩小搜索范围，实现更精确的信息检索。

### 技术原理
过滤器通过在 SQL 查询中添加 WHERE 子句实现，使用 JSONB 列的 `contains` 操作符来匹配元数据。支持多条件组合过滤。

### 配置与执行
```python
from agno.agent import Agent
from agno.knowledge.knowledge import Knowledge
from agno.vectordb.lancedb import LanceDb

# 初始化知识库并添加带元数据的内容
knowledge = Knowledge(vector_db=LanceDb(table_name="docs", uri="tmp/lancedb"))
knowledge.add_content(
    path="data.csv", 
    metadata={
        "type": "sales", 
        "quarter": "Q1",
        "region": "north_america"
    }
)

# 使用过滤器执行搜索
agent = Agent(knowledge=knowledge, search_knowledge=True)
response = agent.print_response(
    "Q1销售趋势是什么？",
    knowledge_filters={"quarter": "Q1", "region": "north_america"},
    markdown=True,
)
```

### 支持的过滤类型
- 基于元数据的过滤
- 时间戳过滤
- 多条件组合过滤
- 错误处理过滤

**Section sources**
- [filtering.py](file://cookbook/knowledge/filters/filtering.py#L0-L83)
- [README.md](file://cookbook/knowledge/filters/README.md#L0-L60)
- [types.py](file://libs/agno/agno/knowledge/types.py#L0-L38)

## 智能体中的RAG实现
在智能体中实现支持混合搜索和过滤的RAG查询需要综合运用上述技术。

### 实现步骤
1. 配置向量数据库使用混合搜索模式
2. 设置适当的向量得分权重
3. 在知识库中添加内容时包含元数据
4. 在查询时应用过滤器条件

### 代码示例
```python
from agno.agent import Agent
from agno.knowledge.knowledge import Knowledge
from agno.models.openai import OpenAIChat
from agno.vectordb.pgvector import PgVector, SearchType

# 配置混合搜索的知识库
knowledge = Knowledge(
    vector_db=PgVector(
        table_name="docs",
        db_url="your_db_url",
        search_type=SearchType.hybrid,
        vector_score_weight=0.7
    )
)

# 创建智能体
agent = Agent(
    model=OpenAIChat(id="gpt-4o"),
    knowledge=knowledge,
    search_knowledge=True
)

# 执行带过滤的混合搜索查询
results = agent.print_response(
    "关于鸡肉椰奶汤的食谱",
    knowledge_filters={"category": "thai", "year": 2024},
    markdown=True
)
```

**Section sources**
- [hybrid_search.py](file://cookbook/knowledge/search_type/hybrid_search.py#L0-L20)
- [filtering.py](file://cookbook/knowledge/filters/filtering.py#L0-L83)

## 总结
Agno 提供了三种强大的检索模式：向量搜索、关键词搜索和混合搜索，每种模式都有其独特的优势和适用场景。通过合理配置和使用过滤器，可以显著提高信息检索的准确性和效率。混合搜索模式特别适合需要平衡语义理解和精确匹配的应用场景，而过滤器则为精细化控制检索范围提供了有力工具。