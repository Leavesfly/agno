# 记忆系统集成

<cite>
**本文档中引用的文件**
- [mem0_integration.py](file://cookbook/integrations/memory/mem0_integration.py)
- [zep_integration.py](file://cookbook/integrations/memory/zep_integration.py)
- [zep.py](file://libs/agno/agno/tools/zep.py)
- [mem0.py](file://libs/agno/agno/tools/mem0.py)
- [manager.py](file://libs/agno/agno/memory/manager.py)
- [base.py](file://libs/agno/agno/db/base.py)
- [01_agent_with_memory.py](file://cookbook/memory/01_agent_with_memory.py)
- [02_agentic_memory.py](file://cookbook/memory/02_agentic_memory.py)
</cite>

## 目录
1. [引言](#引言)
2. [记忆系统架构](#记忆系统架构)
3. [核心组件分析](#核心组件分析)
4. [Mem0集成](#mem0集成)
5. [Zep集成](#zep集成)
6. [记忆生命周期管理](#记忆生命周期管理)
7. [记忆存储与检索](#记忆存储与检索)
8. [隐私保护机制](#隐私保护机制)
9. [高级话题](#高级话题)
10. [结论](#结论)

## 引言
Agno平台提供了一套完整的记忆系统集成方案，支持与外部记忆管理服务如Mem0和Zep的无缝集成。本文档详细阐述了如何在智能体对话中利用长期记忆实现个性化交互，包括用户记忆的存储、检索和上下文注入等关键功能。通过代码示例展示了记忆数据的结构化存储方式、语义搜索能力以及隐私保护机制，帮助开发者构建具有持续学习能力的智能体应用。

## 记忆系统架构
Agno的记忆系统采用分层架构设计，将记忆管理功能与智能体核心逻辑分离，实现了灵活的可扩展性。系统通过工具包（Toolkit）机制与外部记忆平台集成，支持多种记忆存储后端。

```mermaid
graph TD
subgraph "智能体层"
Agent[智能体]
Model[模型]
end
subgraph "记忆管理层"
MemoryManager[记忆管理器]
Tools[工具包]
end
subgraph "存储层"
ExternalMemory[外部记忆平台]
Database[数据库]
end
Agent --> MemoryManager
MemoryManager --> Tools
Tools --> ExternalMemory
MemoryManager --> Database
Agent --> Model
```

**图示来源**
- [manager.py](file://libs/agno/agno/memory/manager.py#L1-L1074)
- [zep.py](file://libs/agno/agno/tools/zep.py#L1-L455)

## 核心组件分析

### 记忆管理器
记忆管理器是Agno记忆系统的核心组件，负责协调记忆的创建、更新、删除和检索操作。它通过抽象接口与不同的记忆存储后端通信，确保了系统的灵活性和可扩展性。

**组件功能**
- 记忆生命周期管理
- 记忆检索策略实现
- 数据库操作抽象
- 用户记忆上下文注入

**组件关系**
```mermaid
classDiagram
class MemoryManager {
+model : Model
+system_message : str
+memory_capture_instructions : str
+additional_instructions : str
+memories_updated : bool
+db : BaseDb
+debug_mode : bool
+get_model() Model
+read_from_db(user_id) Dict
+set_log_level() void
+initialize(user_id) void
+get_user_memories(user_id) List[UserMemory]
+get_user_memory(memory_id, user_id) UserMemory
+add_user_memory(memory, user_id) str
+replace_user_memory(memory_id, memory, user_id) str
+clear() void
+delete_user_memory(memory_id, user_id) void
+create_user_memories(message, messages, agent_id, team_id, user_id) str
+acreate_user_memories(message, messages, agent_id, team_id, user_id) str
+update_memory_task(task, user_id) str
+aupdate_memory_task(task, user_id) str
+_upsert_db_memory(memory) str
+_delete_db_memory(memory_id) str
+search_user_memories(query, limit, retrieval_method, user_id) List[UserMemory]
+_get_response_format() Union[Dict, Type[BaseModel]]
+_search_user_memories_agentic(user_id, query, limit) List[UserMemory]
+_get_last_n_memories(user_id, limit) List[UserMemory]
+_get_first_n_memories(user_id, limit) List[UserMemory]
+determine_tools_for_model(tools) void
+get_system_message(existing_memories, enable_delete_memory, enable_clear_memory, enable_update_memory, enable_add_memory) Message
+create_or_update_memories(messages, existing_memories, user_id, db, agent_id, team_id, update_memories, add_memories) str
+acreate_or_update_memories(messages, existing_memories, user_id, db, agent_id, team_id, update_memories, add_memories) str
}
class BaseDb {
+id : str
+session_table_name : str
+memory_table_name : str
+metrics_table_name : str
+eval_table_name : str
+knowledge_table_name : str
+delete_session(session_id) bool
+delete_sessions(session_ids) void
+get_session(session_id, session_type, user_id, deserialize) Optional[Union[Session, Dict]]
+get_sessions(session_type, user_id, component_id, session_name, start_timestamp, end_timestamp, limit, page, sort_by, sort_order, deserialize) Union[List[Session], Tuple[List[Dict], int]]
+rename_session(session_id, session_type, session_name, deserialize) Optional[Union[Session, Dict]]
+upsert_session(session, deserialize) Optional[Union[Session, Dict]]
+clear_memories() void
+delete_user_memory(memory_id) void
+delete_user_memories(memory_ids) void
+get_all_memory_topics() List[str]
+get_user_memory(memory_id, deserialize) Optional[Union[UserMemory, Dict]]
+get_user_memories(user_id, agent_id, team_id, topics, search_content, limit, page, sort_by, sort_order, deserialize) Union[List[UserMemory], Tuple[List[Dict], int]]
+get_user_memory_stats(limit, page) Tuple[List[Dict], int]
+upsert_user_memory(memory, deserialize) Optional[Union[UserMemory, Dict]]
+get_metrics(starting_date, ending_date) Tuple[List[Dict], Optional[int]]
+calculate_metrics() Optional[Any]
+delete_knowledge_content(id) void
+get_knowledge_content(id) Optional[KnowledgeRow]
+get_knowledge_contents(limit, page, sort_by, sort_order) Tuple[List[KnowledgeRow], int]
+upsert_knowledge_content(knowledge_row) Optional[KnowledgeRow]
+create_eval_run(eval_run) Optional[EvalRunRecord]
+delete_eval_runs(eval_run_ids) void
+get_eval_run(eval_run_id, deserialize) Optional[Union[EvalRunRecord, Dict]]
+get_eval_runs(limit, page, sort_by, sort_order, agent_id, team_id, workflow_id, model_id, filter_type, eval_type, deserialize) Union[List[EvalRunRecord], Tuple[List[Dict], int]]
+rename_eval_run(eval_run_id, name, deserialize) Optional[Union[EvalRunRecord, Dict]]
}
class UserMemory {
+memory_id : str
+user_id : str
+memory : str
+topics : List[str]
+created_at : datetime
+updated_at : datetime
}
MemoryManager --> BaseDb : "依赖"
MemoryManager --> UserMemory : "管理"
```

**图示来源**
- [manager.py](file://libs/agno/agno/memory/manager.py#L1-L1074)
- [base.py](file://libs/agno/agno/db/base.py#L1-L246)

**本节来源**
- [manager.py](file://libs/agno/agno/memory/manager.py#L1-L1074)
- [base.py](file://libs/agno/agno/db/base.py#L1-L246)

## Mem0集成

### Mem0工具包
Mem0工具包提供了与Mem0记忆平台的集成接口，支持记忆的添加、搜索、获取和删除操作。工具包通过API密钥进行身份验证，并支持多种配置选项。

```mermaid
sequenceDiagram
participant Agent as "智能体"
participant Mem0Tools as "Mem0工具包"
participant Mem0Client as "Mem0客户端"
participant MemoryStorage as "记忆存储"
Agent->>Mem0Tools : 初始化(Mem0Tools)
Mem0Tools->>Mem0Client : 创建客户端(API密钥)
Mem0Client-->>Mem0Tools : 客户端实例
Mem0Tools-->>Agent : 工具包实例
Agent->>Mem0Tools : add_memory(内容)
Mem0Tools->>Mem0Client : add(消息列表, 用户ID)
Mem0Client->>MemoryStorage : 存储记忆
MemoryStorage-->>Mem0Client : 确认
Mem0Client-->>Mem0Tools : 结果
Mem0Tools-->>Agent : JSON响应
Agent->>Mem0Tools : search_memory(查询)
Mem0Tools->>Mem0Client : search(查询, 用户ID)
Mem0Client->>MemoryStorage : 搜索记忆
MemoryStorage-->>Mem0Client : 搜索结果
Mem0Client-->>Mem0Tools : 结果列表
Mem0Tools-->>Agent : JSON结果
Agent->>Mem0Tools : get_all_memories()
Mem0Tools->>Mem0Client : get_all(用户ID)
Mem0Client->>MemoryStorage : 获取所有记忆
MemoryStorage-->>Mem0Client : 记忆列表
Mem0Client-->>Mem0Tools : 结果
Mem0Tools-->>Agent : JSON列表
Agent->>Mem0Tools : delete_all_memories()
Mem0Tools->>Mem0Client : delete_all(用户ID)
Mem0Client->>MemoryStorage : 删除所有记忆
MemoryStorage-->>Mem0Client : 确认
Mem0Client-->>Mem0Tools : 确认
Mem0Tools-->>Agent : 删除确认
```

**图示来源**
- [mem0.py](file://libs/agno/agno/tools/mem0.py#L1-L194)
- [mem0_integration.py](file://cookbook/integrations/memory/mem0_integration.py#L1-L34)

### Mem0集成示例
以下示例展示了如何在Agno智能体中集成Mem0记忆系统：

```python
from agno.agent import Agent
from agno.models.openai import OpenAIChat
from agno.utils.pprint import pprint_run_response
from mem0 import MemoryClient

# 初始化Mem0客户端
client = MemoryClient()

# 设置用户ID
user_id = "agno"

# 添加用户记忆
messages = [
    {"role": "user", "content": "My name is John Billings."},
    {"role": "user", "content": "I live in NYC."},
    {"role": "user", "content": "I'm going to a concert tomorrow."},
]
client.add(messages, user_id=user_id)

# 创建智能体并注入记忆
agent = Agent(
    model=OpenAIChat(),
    dependencies={"memory": client.get_all(user_id=user_id)},
    add_dependencies_to_context=True,
)

# 查询用户记忆
run = agent.run("What do you know about me?")
pprint_run_response(run)

# 更新记忆
input = [{"role": i.role, "content": str(i.content)} for i in (run.messages or [])]
client.add(messages, user_id=user_id)
```

**本节来源**
- [mem0_integration.py](file://cookbook/integrations/memory/mem0_integration.py#L1-L34)
- [mem0.py](file://libs/agno/agno/tools/mem0.py#L1-L194)

## Zep集成

### Zep工具包
Zep工具包提供了与Zep记忆平台的同步和异步集成接口，支持会话管理、记忆添加、记忆检索和语义搜索等功能。工具包通过API密钥进行身份验证，并支持会话和用户ID的自动管理。

```mermaid
classDiagram
class ZepTools {
+_api_key : str
+instructions : str
+zep_client : Optional[Zep]
+_initialized : bool
+session_id_provided : Optional[str]
+user_id_provided : Optional[str]
+ignore_assistant_messages : bool
+session_id : Optional[str]
+user_id : Optional[str]
+__init__(session_id, user_id, api_key, ignore_assistant_messages, enable_add_zep_message, enable_get_zep_memory, enable_search_zep_memory, instructions, add_instructions, all, **kwargs) void
+initialize() bool
+add_zep_message(role, content) str
+get_zep_memory(memory_type) str
+search_zep_memory(query, search_scope) str
}
class ZepAsyncTools {
+_api_key : str
+instructions : str
+zep_client : Optional[AsyncZep]
+_initialized : bool
+session_id_provided : Optional[str]
+user_id_provided : Optional[str]
+ignore_assistant_messages : bool
+session_id : Optional[str]
+user_id : Optional[str]
+__init__(session_id, user_id, api_key, ignore_assistant_messages, add_zep_message, get_zep_memory, search_zep_memory, instructions, add_instructions, **kwargs) void
+initialize() bool
+add_zep_message(role, content) str
+get_zep_memory(memory_type) str
+search_zep_memory(query, scope, limit) str
}
ZepTools <|-- ZepAsyncTools : "继承"
```

**图示来源**
- [zep.py](file://libs/agno/agno/tools/zep.py#L1-L455)

### Zep集成示例
以下示例展示了如何在Agno智能体中集成Zep记忆系统：

```python
import time
from agno.agent import Agent
from agno.models.openai import OpenAIChat
from agno.tools.zep import ZepTools

# 初始化Zep工具
zep_tools = ZepTools(user_id="agno", session_id="agno-session")

# 添加用户记忆
zep_tools.add_zep_message(role="user", content="My name is John Billings")
zep_tools.add_zep_message(role="user", content="I live in NYC")
zep_tools.add_zep_message(role="user", content="I'm going to a concert tomorrow")

# 等待记忆同步
time.sleep(10)

# 创建智能体并注入记忆
agent = Agent(
    model=OpenAIChat(),
    tools=[zep_tools],
    dependencies={"memory": zep_tools.get_zep_memory(memory_type="context")},
    add_dependencies_to_context=True,
)

# 查询用户记忆
agent.print_response("What do you know about me?")
```

**本节来源**
- [zep_integration.py](file://cookbook/integrations/memory/zep_integration.py#L1-L27)
- [zep.py](file://libs/agno/agno/tools/zep.py#L1-L455)

## 记忆生命周期管理

### 记忆创建与更新
Agno的记忆系统支持自动和手动两种记忆创建方式。自动记忆创建通过智能体的对话内容分析实现，而手动记忆创建则通过工具调用完成。

```mermaid
flowchart TD
Start([开始]) --> CheckEnableAgenticMemory{启用智能记忆?}
CheckEnableAgenticMemory --> |是| AnalyzeMessages["分析消息内容"]
AnalyzeMessages --> DetermineMemoryAction["确定记忆操作"]
DetermineMemoryAction --> CheckNeedAddMemory{需要添加记忆?}
CheckNeedAddMemory --> |是| AddMemory["添加记忆"]
AddMemory --> End([结束])
CheckNeedAddMemory --> |否| CheckNeedUpdateMemory{需要更新记忆?}
CheckNeedUpdateMemory --> |是| UpdateMemory["更新记忆"]
UpdateMemory --> End
CheckNeedUpdateMemory --> |否| CheckNeedDeleteMemory{需要删除记忆?}
CheckNeedDeleteMemory --> |是| DeleteMemory["删除记忆"]
DeleteMemory --> End
CheckNeedDeleteMemory --> |否| NoAction["无需操作"]
NoAction --> End
CheckEnableAgenticMemory --> |否| ManualMemoryOperation["手动记忆操作"]
ManualMemoryOperation --> End
```

**图示来源**
- [manager.py](file://libs/agno/agno/memory/manager.py#L1-L1074)
- [02_agentic_memory.py](file://cookbook/memory/02_agentic_memory.py#L1-L67)

### 记忆压缩与优化
Agno的记忆系统实现了记忆压缩机制，通过合并相似记忆和删除过时记忆来优化存储效率。系统还支持记忆检索优化，提高查询性能。

```mermaid
flowchart TD
Start([记忆优化开始]) --> CheckMemoryCount{记忆数量超过阈值?}
CheckMemoryCount --> |是| ClusterMemories["聚类相似记忆"]
ClusterMemories --> MergeSimilarMemories["合并相似记忆"]
MergeSimilarMemories --> RemoveOutdatedMemories["删除过时记忆"]
RemoveOutdatedMemories --> UpdateMemoryIndex["更新记忆索引"]
UpdateMemoryIndex --> End([记忆优化完成])
CheckMemoryCount --> |否| End
```

**图示来源**
- [manager.py](file://libs/agno/agno/memory/manager.py#L1-L1074)

**本节来源**
- [manager.py](file://libs/agno/agno/memory/manager.py#L1-L1074)
- [02_agentic_memory.py](file://cookbook/memory/02_agentic_memory.py#L1-L67)

## 记忆存储与检索

### 记忆存储结构
Agno的记忆数据采用结构化存储方式，每个记忆记录包含唯一ID、用户ID、记忆内容、主题标签和时间戳等字段。这种设计支持高效的查询和索引操作。

```mermaid
erDiagram
USER_MEMORY {
string memory_id PK
string user_id FK
string memory
string topics[]
timestamp created_at
timestamp updated_at
}
USER {
string user_id PK
string name
string email
timestamp created_at
}
SESSION {
string session_id PK
string user_id FK
string session_name
timestamp created_at
timestamp updated_at
}
USER_MEMORY ||--o{ USER : "属于"
USER_MEMORY ||--o{ SESSION : "关联"
SESSION ||--o{ USER : "属于"
```

**图示来源**
- [base.py](file://libs/agno/agno/db/base.py#L1-L246)
- [manager.py](file://libs/agno/agno/memory/manager.py#L1-L1074)

### 记忆检索策略
Agno支持多种记忆检索策略，包括最近N条记忆、最旧N条记忆和智能语义搜索。这些策略可以根据应用场景灵活选择。

```mermaid
flowchart TD
Start([检索记忆]) --> SelectRetrievalMethod{选择检索方法}
SelectRetrievalMethod --> CheckLastN{最近N条?}
CheckLastN --> |是| GetLastNMemories["获取最近N条记忆"]
GetLastNMemories --> SortByTimestamp["按时间戳排序"]
SortByTimestamp --> ReturnResults["返回结果"]
CheckLastN --> |否| CheckFirstN{最旧N条?}
CheckFirstN --> |是| GetFirstNMemories["获取最旧N条记忆"]
GetFirstNMemories --> SortByTimestamp
CheckFirstN --> |否| CheckAgentic{智能语义搜索?}
CheckAgentic --> |是| PerformSemanticSearch["执行语义搜索"]
PerformSemanticSearch --> ReturnResults
CheckAgentic --> |否| ReturnAllMemories["返回所有记忆"]
ReturnAllMemories --> ReturnResults
ReturnResults --> End([结束])
```

**图示来源**
- [manager.py](file://libs/agno/agno/memory/manager.py#L1-L1074)

**本节来源**
- [manager.py](file://libs/agno/agno/memory/manager.py#L1-L1074)
- [base.py](file://libs/agno/agno/db/base.py#L1-L246)

## 隐私保护机制
Agno的记忆系统实现了多层次的隐私保护机制，确保用户数据的安全性和合规性。系统支持记忆的加密存储、访问控制和数据删除功能。

```mermaid
flowchart TD
Start([隐私保护]) --> DataEncryption["数据加密"]
DataEncryption --> AccessControl["访问控制"]
AccessControl --> DataAnonymization["数据匿名化"]
DataAnonymization --> DataRetention["数据保留策略"]
DataRetention --> DataDeletion["数据删除"]
DataDeletion --> AuditLogging["审计日志"]
AuditLogging --> End([完成])
```

**本节来源**
- [manager.py](file://libs/agno/agno/memory/manager.py#L1-L1074)
- [base.py](file://libs/agno/agno/db/base.py#L1-L246)

## 高级话题

### 记忆上下文注入
Agno支持将用户记忆作为上下文注入到智能体的对话中，实现个性化的交互体验。系统通过依赖注入机制将记忆数据传递给智能体。

```mermaid
sequenceDiagram
participant User as "用户"
participant Agent as "智能体"
participant MemoryManager as "记忆管理器"
User->>Agent : 发送消息
Agent->>MemoryManager : 请求用户记忆
MemoryManager->>MemoryManager : 检索相关记忆
MemoryManager-->>Agent : 返回记忆数据
Agent->>Agent : 将记忆注入上下文
Agent->>User : 生成个性化响应
```

**图示来源**
- [01_agent_with_memory.py](file://cookbook/memory/01_agent_with_memory.py#L1-L57)
- [manager.py](file://libs/agno/agno/memory/manager.py#L1-L1074)

### 多用户多会话管理
Agno的记忆系统支持多用户多会话场景，能够为不同用户和会话维护独立的记忆空间。系统通过用户ID和会话ID进行记忆隔离。

```mermaid
flowchart TD
Start([多用户会话]) --> CreateUserSession["创建用户会话"]
CreateUserSession --> AssignUserID["分配用户ID"]
AssignUserID --> AssignSessionID["分配会话ID"]
AssignSessionID --> StoreMemory["存储记忆(用户ID, 会话ID)"]
StoreMemory --> RetrieveMemory["检索记忆(用户ID, 会话ID)"]
RetrieveMemory --> End([完成])
```

**图示来源**
- [05_multi_user_multi_session_chat.py](file://cookbook/memory/05_multi_user_multi_session_chat.py)
- [manager.py](file://libs/agno/agno/memory/manager.py#L1-L1074)

**本节来源**
- [01_agent_with_memory.py](file://cookbook/memory/01_agent_with_memory.py#L1-L57)
- [05_multi_user_multi_session_chat.py](file://cookbook/memory/05_multi_user_multi_session_chat.py)
- [manager.py](file://libs/agno/agno/memory/manager.py#L1-L1074)

## 结论
Agno的记忆系统集成方案为开发者提供了强大的长期记忆管理能力，支持与Mem0和Zep等外部记忆平台的无缝集成。通过结构化的记忆存储、智能的检索策略和完善的隐私保护机制，开发者可以构建具有持续学习能力的智能体应用。系统的设计注重灵活性和可扩展性，能够适应各种应用场景的需求。