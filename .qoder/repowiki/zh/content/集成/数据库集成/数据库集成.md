# 数据库集成

<cite>
**本文档中引用的文件**  
- [postgres.py](file://libs/agno/agno/db/postgres/postgres.py)
- [mongo.py](file://libs/agno/agno/db/mongo/mongo.py)
- [redis.py](file://libs/agno/agno/db/redis/redis.py)
- [dynamo.py](file://libs/agno/agno/db/dynamo/dynamo.py)
- [firestore.py](file://libs/agno/agno/db/firestore/firestore.py)
- [sqlite.py](file://libs/agno/agno/db/sqlite/sqlite.py)
- [mysql.py](file://libs/agno/agno/db/mysql/mysql.py)
- [singlestore.py](file://libs/agno/agno/db/singlestore/singlestore.py)
- [db_app.py](file://libs/agno_infra/agno/base/db_app.py)
- [README.md](file://cookbook/db/README.md)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介
Agno 是一个支持多种数据库系统的智能体框架，允许开发者在智能体、团队和工作流中使用不同的数据库进行状态持久化、会话存储和知识管理。本文档详细阐述了 Agno 如何集成关系型数据库（如 PostgreSQL、MySQL、SQLite）和 NoSQL 数据库（如 MongoDB、Redis、DynamoDB、Firestore），并提供配置方法、连接参数、最佳实践以及性能调优建议。

## 项目结构
Agno 的数据库集成功能主要分布在 `libs/agno/agno/db` 目录下，每个数据库类型都有独立的适配器实现。此外，`cookbook/db` 目录提供了各种数据库集成的示例代码。

```mermaid
graph TD
subgraph "数据库适配器"
Postgres[PostgreSQL]
MySQL[MySQL]
SQLite[SQLite]
Mongo[MongoDB]
Redis[Redis]
Dynamo[DynamoDB]
Firestore[Firestore]
end
subgraph "示例代码"
Examples[cookbook/db]
end
Examples --> Postgres
Examples --> MySQL
Examples --> SQLite
Examples --> Mongo
Examples --> Redis
Examples --> Dynamo
Examples --> Firestore
```

**图表来源**  
- [postgres.py](file://libs/agno/agno/db/postgres/postgres.py)
- [mongo.py](file://libs/agno/agno/db/mongo/mongo.py)
- [redis.py](file://libs/agno/agno/db/redis/redis.py)
- [dynamo.py](file://libs/agno/agno/db/dynamo/dynamo.py)
- [firestore.py](file://libs/agno/agno/db/firestore/firestore.py)
- [sqlite.py](file://libs/agno/agno/db/sqlite/sqlite.py)
- [mysql.py](file://libs/agno/agno/db/mysql/mysql.py)
- [singlestore.py](file://libs/agno/agno/db/singlestore/singlestore.py)

**章节来源**  
- [README.md](file://cookbook/db/README.md)

## 核心组件
Agno 的数据库集成基于统一的 `BaseDb` 接口，所有数据库适配器都继承自该接口。每个适配器负责处理特定数据库的连接、会话管理、内存存储和知识管理。

**章节来源**  
- [postgres.py](file://libs/agno/agno/db/postgres/postgres.py)
- [mongo.py](file://libs/agno/agno/db/mongo/mongo.py)
- [redis.py](file://libs/agno/agno/db/redis/redis.py)

## 架构概述
Agno 的数据库架构采用分层设计，上层为智能体、团队和工作流提供统一的数据库接口，底层为各个数据库适配器实现具体的数据库操作。

```mermaid
graph TB
subgraph "应用层"
Agent[智能体]
Team[团队]
Workflow[工作流]
end
subgraph "数据库接口层"
BaseDb[BaseDb]
end
subgraph "数据库适配器层"
Postgres[PostgreSQL]
MySQL[MySQL]
SQLite[SQLite]
Mongo[MongoDB]
Redis[Redis]
Dynamo[DynamoDB]
Firestore[Firestore]
end
Agent --> BaseDb
Team --> BaseDb
Workflow --> BaseDb
BaseDb --> Postgres
BaseDb --> MySQL
BaseDb --> SQLite
BaseDb --> Mongo
BaseDb --> Redis
BaseDb --> Dynamo
BaseDb --> Firestore
```

**图表来源**  
- [postgres.py](file://libs/agno/agno/db/postgres/postgres.py)
- [mongo.py](file://libs/agno/agno/db/mongo/mongo.py)
- [redis.py](file://libs/agno/agno/db/redis/redis.py)
- [dynamo.py](file://libs/agno/agno/db/dynamo/dynamo.py)
- [firestore.py](file://libs/agno/agno/db/firestore/firestore.py)
- [sqlite.py](file://libs/agno/agno/db/sqlite/sqlite.py)
- [mysql.py](file://libs/agno/agno/db/mysql/mysql.py)
- [singlestore.py](file://libs/agno/agno/db/singlestore/singlestore.py)

## 详细组件分析
### PostgreSQL 分析
PostgreSQL 适配器使用 SQLAlchemy 作为 ORM 工具，支持复杂的查询和事务处理。

```mermaid
classDiagram
class PostgresDb {
+db_url : str
+db_engine : Engine
+db_schema : str
+session_table : str
+memory_table : str
+metrics_table : str
+eval_table : str
+knowledge_table : str
+__init__(db_url : str, db_engine : Engine, db_schema : str, session_table : str, memory_table : str, metrics_table : str, eval_table : str, knowledge_table : str)
+_create_table(table_name : str, table_type : str, db_schema : str) : Table
+_get_table(table_type : str, create_table_if_not_found : bool) : Table
}
```

**图表来源**  
- [postgres.py](file://libs/agno/agno/db/postgres/postgres.py)

**章节来源**  
- [postgres.py](file://libs/agno/agno/db/postgres/postgres.py)

### MongoDB 分析
MongoDB 适配器使用 PyMongo 作为驱动程序，支持灵活的文档存储和查询。

```mermaid
classDiagram
class MongoDb {
+db_client : MongoClient
+db_name : str
+session_collection : str
+memory_collection : str
+metrics_collection : str
+eval_collection : str
+knowledge_collection : str
+__init__(db_client : MongoClient, db_name : str, db_url : str, session_collection : str, memory_collection : str, metrics_collection : str, eval_collection : str, knowledge_collection : str)
+_get_collection(table_type : str, create_collection_if_not_found : bool) : Collection
+_get_or_create_collection(collection_name : str, collection_type : str, create_collection_if_not_found : bool) : Collection
}
```

**图表来源**  
- [mongo.py](file://libs/agno/agno/db/mongo/mongo.py)

**章节来源**  
- [mongo.py](file://libs/agno/agno/db/mongo/mongo.py)

### Redis 分析
Redis 适配器使用 Redis-py 作为客户端，支持高速缓存和会话存储。

```mermaid
classDiagram
class RedisDb {
+redis_client : Redis
+db_url : str
+db_prefix : str
+expire : int
+session_table : str
+memory_table : str
+metrics_table : str
+eval_table : str
+knowledge_table : str
+__init__(redis_client : Redis, db_url : str, db_prefix : str, expire : int, session_table : str, memory_table : str, metrics_table : str, eval_table : str, knowledge_table : str)
+_get_table_name(table_type : str) : str
+_store_record(table_type : str, record_id : str, data : Dict[str, Any], index_fields : List[str]) : bool
+_get_record(table_type : str, record_id : str) : Dict[str, Any]
+_delete_record(table_type : str, record_id : str, index_fields : List[str]) : bool
}
```

**图表来源**  
- [redis.py](file://libs/agno/agno/db/redis/redis.py)

**章节来源**  
- [redis.py](file://libs/agno/agno/db/redis/redis.py)

### DynamoDB 分析
DynamoDB 适配器使用 Boto3 作为 AWS SDK，支持高可用性和可扩展性的 NoSQL 存储。

```mermaid
classDiagram
class DynamoDb {
+client : DynamoDB.Client
+region_name : str
+aws_access_key_id : str
+aws_secret_access_key : str
+session_table : str
+memory_table : str
+metrics_table : str
+eval_table : str
+knowledge_table : str
+__init__(db_client : DynamoDB.Client, region_name : str, aws_access_key_id : str, aws_secret_access_key : str, session_table : str, memory_table : str, metrics_table : str, eval_table : str, knowledge_table : str)
+_create_tables() : None
+_table_exists(table_name : str) : bool
+_get_table(table_type : str, create_table_if_not_found : bool) : str
}
```

**图表来源**  
- [dynamo.py](file://libs/agno/agno/db/dynamo/dynamo.py)

**章节来源**  
- [dynamo.py](file://libs/agno/agno/db/dynamo/dynamo.py)

### Firestore 分析
Firestore 适配器使用 Google Cloud Firestore 客户端库，支持实时数据同步和灵活的查询。

```mermaid
classDiagram
class FirestoreDb {
+db_client : Client
+project_id : str
+session_collection : str
+memory_collection : str
+metrics_collection : str
+eval_collection : str
+knowledge_collection : str
+__init__(db_client : Client, project_id : str, session_collection : str, memory_collection : str, metrics_collection : str, eval_collection : str, knowledge_collection : str)
+_get_collection(table_type : str, create_collection_if_not_found : bool) : CollectionReference
+_get_or_create_collection(collection_name : str, collection_type : str, create_collection_if_not_found : bool) : CollectionReference
}
```

**图表来源**  
- [firestore.py](file://libs/agno/agno/db/firestore/firestore.py)

**章节来源**  
- [firestore.py](file://libs/agno/agno/db/firestore/firestore.py)

### SQLite 分析
SQLite 适配器使用 SQLAlchemy 作为 ORM 工具，支持轻量级的文件数据库。

```mermaid
classDiagram
class SqliteDb {
+db_engine : Engine
+db_url : str
+db_file : str
+session_table : str
+memory_table : str
+metrics_table : str
+eval_table : str
+knowledge_table : str
+__init__(db_engine : Engine, db_url : str, db_file : str, session_table : str, memory_table : str, metrics_table : str, eval_table : str, knowledge_table : str)
+_create_table(table_name : str, table_type : str) : Table
+_get_table(table_type : str, create_table_if_not_found : bool) : Table
}
```

**图表来源**  
- [sqlite.py](file://libs/agno/agno/db/sqlite/sqlite.py)

**章节来源**  
- [sqlite.py](file://libs/agno/agno/db/sqlite/sqlite.py)

### MySQL 分析
MySQL 适配器使用 SQLAlchemy 作为 ORM 工具，支持标准的 SQL 查询和事务处理。

```mermaid
classDiagram
class MySQLDb {
+db_engine : Engine
+db_url : str
+db_schema : str
+session_table : str
+memory_table : str
+metrics_table : str
+eval_table : str
+knowledge_table : str
+__init__(db_engine : Engine, db_url : str, db_schema : str, session_table : str, memory_table : str, metrics_table : str, eval_table : str, knowledge_table : str)
+_create_table(table_name : str, table_type : str, db_schema : str) : Table
+_get_table(table_type : str, create_table_if_not_found : bool) : Table
}
```

**图表来源**  
- [mysql.py](file://libs/agno/agno/db/mysql/mysql.py)

**章节来源**  
- [mysql.py](file://libs/agno/agno/db/mysql/mysql.py)

### SingleStore 分析
SingleStore 适配器使用 SQLAlchemy 作为 ORM 工具，支持高性能的分布式 SQL 数据库。

```mermaid
classDiagram
class SingleStoreDb {
+db_engine : Engine
+db_url : str
+db_schema : str
+session_table : str
+memory_table : str
+metrics_table : str
+eval_table : str
+knowledge_table : str
+__init__(db_engine : Engine, db_url : str, db_schema : str, session_table : str, memory_table : str, metrics_table : str, eval_table : str, knowledge_table : str)
+_create_table_structure_only(table_name : str, table_type : str, db_schema : str) : Table
+_create_table(table_name : str, table_type : str, db_schema : str) : Table
+_get_table(table_type : str, create_table_if_not_found : bool) : Table
}
```

**图表来源**  
- [singlestore.py](file://libs/agno/agno/db/singlestore/singlestore.py)

**章节来源**  
- [singlestore.py](file://libs/agno/agno/db/singlestore/singlestore.py)

## 依赖分析
Agno 的数据库适配器依赖于相应的数据库驱动程序，这些驱动程序通过 pip 安装。

```mermaid
graph TD
Agno --> PostgreSQL
Agno --> MySQL
Agno --> SQLite
Agno --> MongoDB
Agno --> Redis
Agno --> DynamoDB
Agno --> Firestore
PostgreSQL --> psycopg2
MySQL --> mysql-connector-python
SQLite --> sqlite3
MongoDB --> pymongo
Redis --> redis
DynamoDB --> boto3
Firestore --> google-cloud-firestore
```

**图表来源**  
- [README.md](file://cookbook/db/README.md)

**章节来源**  
- [README.md](file://cookbook/db/README.md)

## 性能考虑
选择合适的数据库对于性能至关重要。PostgreSQL 和 MySQL 适合需要复杂查询和事务处理的场景；MongoDB 和 Redis 适合需要高吞吐量和低延迟的场景；DynamoDB 和 Firestore 适合需要高可用性和可扩展性的场景。

## 故障排除指南
如果遇到数据库连接问题，请检查数据库 URL、用户名、密码和端口是否正确。如果遇到性能问题，请检查数据库索引和查询优化。

**章节来源**  
- [postgres.py](file://libs/agno/agno/db/postgres/postgres.py)
- [mongo.py](file://libs/agno/agno/db/mongo/mongo.py)
- [redis.py](file://libs/agno/agno/db/redis/redis.py)
- [dynamo.py](file://libs/agno/agno/db/dynamo/dynamo.py)
- [firestore.py](file://libs/agno/agno/db/firestore/firestore.py)
- [sqlite.py](file://libs/agno/agno/db/sqlite/sqlite.py)
- [mysql.py](file://libs/agno/agno/db/mysql/mysql.py)
- [singlestore.py](file://libs/agno/agno/db/singlestore/singlestore.py)

## 结论
Agno 提供了丰富的数据库集成选项，开发者可以根据具体需求选择合适的数据库系统。通过统一的接口和灵活的配置，Agno 能够轻松地与各种数据库进行集成，实现高效的状态持久化、会话存储和知识管理。