# è·¯ç”±åˆ†æ”¯å·¥ä½œæµ

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨çš„æ–‡ä»¶**
- [workflow_with_router.py](file://cookbook/agent_os/workflow/workflow_with_router.py)
- [early_stop_workflow_with_router.py](file://cookbook/workflows/_06_advanced_concepts/_02_early_stopping/early_stop_workflow_with_router.py)
- [router.py](file://libs/agno/agno/workflow/router.py)
- [step.py](file://libs/agno/agno/workflow/step.py)
- [types.py](file://libs/agno/agno/workflow/types.py)
- [workflow.py](file://libs/agno/agno/workflow/workflow.py)
</cite>

## ç›®å½•
1. [ç®€ä»‹](#ç®€ä»‹)
2. [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
3. [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)
4. [æ¶æ„æ¦‚è§ˆ](#æ¶æ„æ¦‚è§ˆ)
5. [è¯¦ç»†ç»„ä»¶åˆ†æ](#è¯¦ç»†ç»„ä»¶åˆ†æ)
6. [ä¾èµ–å…³ç³»åˆ†æ](#ä¾èµ–å…³ç³»åˆ†æ)
7. [æ€§èƒ½è€ƒè™‘](#æ€§èƒ½è€ƒè™‘)
8. [æ•…éšœæ’é™¤æŒ‡å—](#æ•…éšœæ’é™¤æŒ‡å—)
9. [ç»“è®º](#ç»“è®º)

## ç®€ä»‹

è·¯ç”±åˆ†æ”¯å·¥ä½œæµæ˜¯Agnoæ¡†æ¶ä¸­çš„ä¸€ä¸ªé«˜çº§åŠŸèƒ½ï¼Œå®ƒå…è®¸å¼€å‘è€…æ ¹æ®è¾“å…¥æ•°æ®æˆ–ä¸Šä¸‹æ–‡åŠ¨æ€é€‰æ‹©ä¸åŒçš„æ‰§è¡Œè·¯å¾„ã€‚ä¸ç®€å•çš„æ¡ä»¶åˆ¤æ–­ä¸åŒï¼Œè·¯ç”±å™¨å¯ä»¥æ”¯æŒå¤šäºä¸¤ä¸ªåˆ†æ”¯çš„é€‰æ‹©ï¼Œä¸ºå¤æ‚çš„å†³ç­–æµç¨‹æä¾›äº†å¼ºå¤§çš„è§£å†³æ–¹æ¡ˆã€‚

è·¯ç”±å™¨çš„æ ¸å¿ƒæ€æƒ³æ˜¯é€šè¿‡ä¸€ä¸ªé€‰æ‹©å™¨å‡½æ•°ï¼ˆselector functionï¼‰æ¥å†³å®šåº”è¯¥æ‰§è¡Œå“ªäº›æ­¥éª¤ã€‚è¿™ä¸ªé€‰æ‹©å™¨å‡½æ•°æ¥æ”¶å½“å‰çš„StepInputä½œä¸ºè¾“å…¥ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ­¥éª¤åˆ—è¡¨ã€‚è·¯ç”±å™¨ä¼šæŒ‰ç…§è¿™ä¸ªåˆ—è¡¨é¡ºåºæ‰§è¡Œè¿™äº›æ­¥éª¤ï¼Œå®ç°äº†çµæ´»çš„åˆ†æ”¯æ§åˆ¶ã€‚

## é¡¹ç›®ç»“æ„

è·¯ç”±åˆ†æ”¯å·¥ä½œæµåœ¨Agnoæ¡†æ¶ä¸­çš„ç»„ç»‡ç»“æ„å¦‚ä¸‹ï¼š

```mermaid
graph TB
subgraph "å·¥ä½œæµæ¨¡å—"
Router[Routerç±»]
Step[Stepç±»]
Workflow[Workflowç±»]
end
subgraph "ç¤ºä¾‹åº”ç”¨"
BasicRouter[åŸºç¡€è·¯ç”±ç¤ºä¾‹]
SafetyRouter[å®‰å…¨æ£€æŸ¥è·¯ç”±ç¤ºä¾‹]
end
subgraph "æ ¸å¿ƒåŠŸèƒ½"
Selector[é€‰æ‹©å™¨å‡½æ•°]
Routing[è·¯ç”±é€»è¾‘]
Execution[æ‰§è¡Œå¼•æ“]
end
Router --> Selector
Router --> Routing
Router --> Execution
BasicRouter --> Router
SafetyRouter --> Router
Workflow --> Router
Workflow --> Step
```

**å›¾è¡¨æ¥æº**
- [router.py](file://libs/agno/agno/workflow/router.py#L1-L50)
- [workflow_with_router.py](file://cookbook/agent_os/workflow/workflow_with_router.py#L1-L30)

**ç« èŠ‚æ¥æº**
- [workflow_with_router.py](file://cookbook/agent_os/workflow/workflow_with_router.py#L1-L116)
- [early_stop_workflow_with_router.py](file://cookbook/workflows/_06_advanced_concepts/_02_early_stopping/early_stop_workflow_with_router.py#L1-L148)

## æ ¸å¿ƒç»„ä»¶

### Routerç±»

Routerç±»æ˜¯è·¯ç”±åˆ†æ”¯å·¥ä½œæµçš„æ ¸å¿ƒç»„ä»¶ï¼Œå®ƒè´Ÿè´£æ ¹æ®è¾“å…¥æ•°æ®åŠ¨æ€é€‰æ‹©å’Œæ‰§è¡Œæ­¥éª¤åºåˆ—ã€‚

```python
@dataclass
class Router:
    """åŸºäºè¾“å…¥åŠ¨æ€é€‰æ‹©è¦æ‰§è¡Œçš„æ­¥éª¤çš„è·¯ç”±å™¨"""
    
    # è¿”å›è¦æ‰§è¡Œçš„æ­¥éª¤çš„è·¯ç”±å™¨å‡½æ•°
    selector: Union[
        Callable[[StepInput], Union[WorkflowSteps, List[WorkflowSteps]]],
        Callable[[StepInput], Awaitable[Union[WorkflowSteps, List[WorkflowSteps]]]],
    ]
    choices: WorkflowSteps  # å¯ä¾›é€‰æ‹©çš„æ­¥éª¤
    
    name: Optional[str] = None
    description: Optional[str] = None
```

### é€‰æ‹©å™¨å‡½æ•°

é€‰æ‹©å™¨å‡½æ•°æ˜¯è·¯ç”±å™¨çš„æ ¸å¿ƒé€»è¾‘ï¼Œå®ƒå†³å®šäº†åº”è¯¥æ‰§è¡Œå“ªäº›æ­¥éª¤ï¼š

```python
def research_router(step_input: StepInput) -> List[Step]:
    """æ ¹æ®è¾“å…¥ä¸»é¢˜å†³å®šä½¿ç”¨å“ªç§ç ”ç©¶æ–¹æ³•"""
    topic = step_input.previous_step_content or step_input.input or ""
    topic = topic.lower()
    
    tech_keywords = [
        "startup", "programming", "ai", "machine learning", "software",
        "developer", "coding", "tech", "silicon valley", "venture capital"
    ]
    
    if any(keyword in topic for keyword in tech_keywords):
        print(f"ğŸ” æŠ€æœ¯ä¸»é¢˜æ£€æµ‹: ä½¿ç”¨HackerNewsç ”ç©¶ '{topic}'")
        return [research_hackernews]
    else:
        print(f"ğŸŒ é€šç”¨ä¸»é¢˜æ£€æµ‹: ä½¿ç”¨ç½‘ç»œç ”ç©¶ '{topic}'")
        return [research_web]
```

**ç« èŠ‚æ¥æº**
- [router.py](file://libs/agno/agno/workflow/router.py#L25-L45)
- [workflow_with_router.py](file://cookbook/agent_os/workflow/workflow_with_router.py#L50-L75)

## æ¶æ„æ¦‚è§ˆ

è·¯ç”±åˆ†æ”¯å·¥ä½œæµçš„æ•´ä½“æ¶æ„å±•ç¤ºäº†å„ä¸ªç»„ä»¶ä¹‹é—´çš„äº¤äº’å…³ç³»ï¼š

```mermaid
sequenceDiagram
participant Client as å®¢æˆ·ç«¯
participant Workflow as å·¥ä½œæµ
participant Router as è·¯ç”±å™¨
participant Selector as é€‰æ‹©å™¨å‡½æ•°
participant Steps as æ­¥éª¤åˆ—è¡¨
participant Executor as æ‰§è¡Œå™¨
Client->>Workflow : æäº¤è¾“å…¥
Workflow->>Router : æ‰§è¡Œè·¯ç”±å™¨
Router->>Selector : è°ƒç”¨é€‰æ‹©å™¨å‡½æ•°
Selector->>Selector : åˆ†æè¾“å…¥æ•°æ®
Selector-->>Router : è¿”å›æ­¥éª¤åˆ—è¡¨
Router->>Steps : å‡†å¤‡æ­¥éª¤
Router->>Executor : é¡ºåºæ‰§è¡Œæ­¥éª¤
loop æ¯ä¸ªæ­¥éª¤
Executor->>Executor : æ‰§è¡Œæ­¥éª¤
Executor-->>Router : è¿”å›ç»“æœ
Router->>Router : æ›´æ–°è¾“å…¥æ•°æ®
end
Router-->>Workflow : è¿”å›æœ€ç»ˆç»“æœ
Workflow-->>Client : è¿”å›å·¥ä½œæµè¾“å‡º
```

**å›¾è¡¨æ¥æº**
- [router.py](file://libs/agno/agno/workflow/router.py#L133-L200)
- [workflow.py](file://libs/agno/agno/workflow/workflow.py#L2186-L2209)

## è¯¦ç»†ç»„ä»¶åˆ†æ

### è·¯ç”±å™¨æ‰§è¡Œæµç¨‹

è·¯ç”±å™¨çš„æ‰§è¡Œè¿‡ç¨‹åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªå…³é”®æ­¥éª¤ï¼š

```mermaid
flowchart TD
Start([å¼€å§‹æ‰§è¡Œè·¯ç”±å™¨]) --> Prepare["å‡†å¤‡æ­¥éª¤<br/>_prepare_steps()"]
Prepare --> Route["è·¯ç”±æ­¥éª¤<br/>_route_steps()"]
Route --> CheckEmpty{"æ­¥éª¤åˆ—è¡¨æ˜¯å¦ä¸ºç©º?"}
CheckEmpty --> |æ˜¯| EmptyReturn["è¿”å›ç©ºç»“æœ"]
CheckEmpty --> |å¦| ExecuteLoop["æ‰§è¡Œæ­¥éª¤å¾ªç¯"]
ExecuteLoop --> GetStep["è·å–ä¸‹ä¸€ä¸ªæ­¥éª¤"]
GetStep --> ExecuteStep["æ‰§è¡Œæ­¥éª¤<br/>step.execute()"]
ExecuteStep --> CheckStop{"æ˜¯å¦è¯·æ±‚æå‰ç»ˆæ­¢?"}
CheckStop --> |æ˜¯| BreakLoop["è·³å‡ºå¾ªç¯"]
CheckStop --> |å¦| UpdateInput["æ›´æ–°è¾“å…¥æ•°æ®<br/>_update_step_input_from_outputs()"]
UpdateInput --> MoreSteps{"è¿˜æœ‰æ›´å¤šæ­¥éª¤?"}
MoreSteps --> |æ˜¯| GetStep
MoreSteps --> |å¦| Complete["å®Œæˆæ‰§è¡Œ"]
EmptyReturn --> End([ç»“æŸ])
BreakLoop --> End
Complete --> End
```

**å›¾è¡¨æ¥æº**
- [router.py](file://libs/agno/agno/workflow/router.py#L133-L200)
- [router.py](file://libs/agno/agno/workflow/router.py#L234-L300)

### é€‰æ‹©å™¨å‡½æ•°çš„å®ç°æ¨¡å¼

é€‰æ‹©å™¨å‡½æ•°å¯ä»¥æ ¹æ®ä¸åŒçš„ä¸šåŠ¡éœ€æ±‚é‡‡ç”¨å¤šç§å®ç°æ¨¡å¼ï¼š

#### 1. åŸºç¡€å…³é”®è¯åŒ¹é…æ¨¡å¼

```python
def basic_keyword_router(step_input: StepInput) -> List[Step]:
    """åŸºäºå…³é”®è¯çš„ç®€å•è·¯ç”±"""
    content = step_input.input.lower()
    
    if "æŠ€æœ¯" in content:
        return [tech_step]
    elif "å¸‚åœº" in content:
        return [market_step]
    elif "è´¢åŠ¡" in content:
        return [finance_step]
    else:
        return [default_step]
```

#### 2. å¤šå±‚å†³ç­–æ¨¡å¼

```python
def hierarchical_router(step_input: StepInput) -> List[Step]:
    """å¤šå±‚å†³ç­–è·¯ç”±"""
    level1_result = level1_selector(step_input)
    
    if level1_result == "complex":
        return [complex_analysis, safety_check, detailed_research]
    elif level1_result == "simple":
        return [quick_research, summary]
    else:
        return [escalation_process]
```

#### 3. åŠ¨æ€é…ç½®æ¨¡å¼

```python
def config_based_router(step_input: StepInput) -> List[Step]:
    """åŸºäºé…ç½®çš„è·¯ç”±"""
    config = load_routing_config()
    topic = extract_topic(step_input.input)
    
    if topic in config:
        return config[topic]["steps"]
    else:
        return config["default"]["steps"]
```

**ç« èŠ‚æ¥æº**
- [workflow_with_router.py](file://cookbook/agent_os/workflow/workflow_with_router.py#L50-L75)
- [early_stop_workflow_with_router.py](file://cookbook/workflows/_06_advanced_concepts/_02_early_stopping/early_stop_workflow_with_router.py#L70-L100)

### æ­¥éª¤å‡†å¤‡å’ŒéªŒè¯

è·¯ç”±å™¨åœ¨æ‰§è¡Œå‰ä¼šè¿›è¡Œæ­¥éª¤å‡†å¤‡å’ŒéªŒè¯ï¼š

```mermaid
classDiagram
class Router {
+selector : Callable
+choices : WorkflowSteps
+name : Optional[str]
+description : Optional[str]
+_prepare_steps()
+_route_steps(step_input)
+execute(step_input)
}
class Step {
+name : Optional[str]
+agent : Optional[Agent]
+team : Optional[Team]
+executor : Optional[StepExecutor]
+execute(step_input)
}
class WorkflowSteps {
<<union>>
Step
Agent
Team
Callable
Router
Loop
Parallel
Condition
}
Router --> WorkflowSteps : "å¤„ç†"
WorkflowSteps --> Step : "åŒ…å«"
Router --> Step : "æ‰§è¡Œ"
```

**å›¾è¡¨æ¥æº**
- [router.py](file://libs/agno/agno/workflow/router.py#L47-L70)
- [step.py](file://libs/agno/agno/workflow/step.py#L25-L50)

**ç« èŠ‚æ¥æº**
- [router.py](file://libs/agno/agno/workflow/router.py#L47-L70)

### æµå¼æ‰§è¡Œæ”¯æŒ

è·¯ç”±å™¨æ”¯æŒæµå¼æ‰§è¡Œï¼Œè¿™å¯¹äºé•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡ç‰¹åˆ«æœ‰ç”¨ï¼š

```python
def execute_stream(
    self,
    step_input: StepInput,
    session_id: Optional[str] = None,
    user_id: Optional[str] = None,
    session_state: Optional[Dict[str, Any]] = None,
    stream_intermediate_steps: bool = False,
    workflow_run_response: Optional[WorkflowRunOutput] = None,
    step_index: Optional[Union[int, tuple]] = None,
    store_executor_outputs: bool = True,
    parent_step_id: Optional[str] = None,
) -> Iterator[Union[WorkflowRunOutputEvent, StepOutput]]:
    """å¸¦æœ‰æµå¼æ”¯æŒçš„è·¯ç”±å™¨æ‰§è¡Œ"""
```

**ç« èŠ‚æ¥æº**
- [router.py](file://libs/agno/agno/workflow/router.py#L234-L300)

## ä¾èµ–å…³ç³»åˆ†æ

è·¯ç”±åˆ†æ”¯å·¥ä½œæµçš„ä¾èµ–å…³ç³»å±•ç°äº†å…¶åœ¨Agnoæ¡†æ¶ä¸­çš„ä½ç½®ï¼š

```mermaid
graph TD
subgraph "å¤–éƒ¨ä¾èµ–"
Pydantic[Pydantic]
UUID[UUID]
Typing[Typingæ¨¡å—]
end
subgraph "å†…éƒ¨æ¨¡å—"
Agent[Agentæ¨¡å—]
Team[Teamæ¨¡å—]
Media[Mediaæ¨¡å—]
Run[Runæ¨¡å—]
Utils[Utilsæ¨¡å—]
end
subgraph "å·¥ä½œæµç»„ä»¶"
Router[Routerç±»]
Step[Stepç±»]
Types[Typesæ¨¡å—]
Workflow[Workflowç±»]
end
Router --> Pydantic
Router --> UUID
Router --> Typing
Router --> Agent
Router --> Team
Router --> Media
Router --> Run
Router --> Utils
Router --> Step
Router --> Types
Router --> Workflow
```

**å›¾è¡¨æ¥æº**
- [router.py](file://libs/agno/agno/workflow/router.py#L1-L20)
- [workflow.py](file://libs/agno/agno/workflow/workflow.py#L69-L85)

**ç« èŠ‚æ¥æº**
- [router.py](file://libs/agno/agno/workflow/router.py#L1-L20)
- [workflow.py](file://libs/agno/agno/workflow/workflow.py#L69-L85)

## æ€§èƒ½è€ƒè™‘

### å¼‚æ­¥æ‰§è¡Œä¼˜åŒ–

è·¯ç”±å™¨æ”¯æŒå¼‚æ­¥æ‰§è¡Œï¼Œå¯ä»¥æ˜¾è‘—æé«˜æ€§èƒ½ï¼š

```python
async def aexecute(
    self,
    step_input: StepInput,
    session_id: Optional[str] = None,
    user_id: Optional[str] = None,
    workflow_run_response: Optional[WorkflowRunOutput] = None,
    session_state: Optional[Dict[str, Any]] = None,
    store_executor_outputs: bool = True,
) -> StepOutput:
    """å¼‚æ­¥æ‰§è¡Œè·¯ç”±å™¨åŠå…¶é€‰å®šçš„æ­¥éª¤"""
```

### å†…å­˜ç®¡ç†

è·¯ç”±å™¨åœ¨å¤„ç†å¤§é‡æ­¥éª¤æ—¶éœ€è¦æ³¨æ„å†…å­˜ç®¡ç†ï¼š

- æ­¥éª¤ç»“æœä¼šè¢«ç´¯ç§¯å­˜å‚¨
- è¾“å…¥æ•°æ®ä¼šåœ¨æ¯ä¸€æ­¥æ›´æ–°
- éœ€è¦æ³¨æ„é¿å…å†…å­˜æ³„æ¼

### å¹¶å‘æ§åˆ¶

è™½ç„¶è·¯ç”±å™¨æœ¬èº«ä¸ç›´æ¥æ”¯æŒå¹¶å‘ï¼Œä½†å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å®ç°ï¼š

```python
# ä½¿ç”¨å¹¶è¡Œæ­¥éª¤åŒ…è£…è·¯ç”±å™¨
parallel_router = Parallel(
    Router(name="router_1", selector=selector1, choices=choices1),
    Router(name="router_2", selector=selector2, choices=choices2),
    name="parallel_routers"
)
```

## æ•…éšœæ’é™¤æŒ‡å—

### å¸¸è§é”™è¯¯å’Œè§£å†³æ–¹æ¡ˆ

#### 1. é€‰æ‹©å™¨å‡½æ•°è¿”å›æ— æ•ˆç±»å‹

**é”™è¯¯ä¿¡æ¯**: `Router function returned unexpected type`

**è§£å†³æ–¹æ¡ˆ**: ç¡®ä¿é€‰æ‹©å™¨å‡½æ•°è¿”å›Stepå¯¹è±¡æˆ–Stepå¯¹è±¡åˆ—è¡¨

```python
# é”™è¯¯çš„åšæ³•
def bad_selector(step_input: StepInput):
    return "some_string"  # åº”è¯¥è¿”å›List[Step]

# æ­£ç¡®çš„åšæ³•
def good_selector(step_input: StepInput) -> List[Step]:
    return [Step(name="correct_step")]
```

#### 2. æ­¥éª¤æ‰§è¡Œå¤±è´¥

**é”™è¯¯ä¿¡æ¯**: `Step failed but skipped`

**è§£å†³æ–¹æ¡ˆ**: æ£€æŸ¥æ­¥éª¤é…ç½®å’Œè¾“å…¥æ•°æ®

```python
# æ·»åŠ é”™è¯¯å¤„ç†
def robust_selector(step_input: StepInput) -> List[Step]:
    try:
        # è·¯ç”±é€»è¾‘
        return [Step(name="safe_step")]
    except Exception as e:
        logger.error(f"Router selector failed: {e}")
        return [fallback_step]
```

#### 3. å†…å­˜æº¢å‡º

**ç—‡çŠ¶**: ç¨‹åºè¿è¡Œç¼“æ…¢æˆ–å´©æºƒ

**è§£å†³æ–¹æ¡ˆ**: 
- é™åˆ¶æ­¥éª¤æ•°é‡
- åŠæ—¶æ¸…ç†ä¸­é—´ç»“æœ
- ä½¿ç”¨æµå¼æ‰§è¡Œ

**ç« èŠ‚æ¥æº**
- [router.py](file://libs/agno/agno/workflow/router.py#L115-L130)
- [router.py](file://libs/agno/agno/workflow/router.py#L133-L200)

## ç»“è®º

è·¯ç”±åˆ†æ”¯å·¥ä½œæµæ˜¯Agnoæ¡†æ¶ä¸­ä¸€ä¸ªå¼ºå¤§è€Œçµæ´»çš„åŠŸèƒ½ï¼Œå®ƒé€šè¿‡é€‰æ‹©å™¨å‡½æ•°å®ç°äº†å¤æ‚çš„å†³ç­–é€»è¾‘ã€‚ä¸ä¼ ç»Ÿçš„æ¡ä»¶åˆ¤æ–­ç›¸æ¯”ï¼Œè·¯ç”±å™¨å…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

1. **çµæ´»æ€§**: æ”¯æŒå¤šåˆ†æ”¯é€‰æ‹©ï¼Œé€‚åº”å¤æ‚çš„ä¸šåŠ¡é€»è¾‘
2. **å¯æ‰©å±•æ€§**: æ˜“äºæ·»åŠ æ–°çš„è·¯ç”±è§„åˆ™å’Œæ­¥éª¤
3. **å¯ç»´æŠ¤æ€§**: å°†è·¯ç”±é€»è¾‘ä¸ä¸šåŠ¡é€»è¾‘åˆ†ç¦»
4. **å¯æµ‹è¯•æ€§**: é€‰æ‹©å™¨å‡½æ•°æ˜“äºå•å…ƒæµ‹è¯•
5. **å¯è§‚å¯Ÿæ€§**: æ”¯æŒæµå¼æ‰§è¡Œå’Œäº‹ä»¶ç›‘æ§

é€šè¿‡åˆç†è®¾è®¡é€‰æ‹©å™¨å‡½æ•°å’Œæ­¥éª¤ç»„åˆï¼Œå¼€å‘è€…å¯ä»¥æ„å»ºå‡ºé«˜æ•ˆã€å¯é çš„æ™ºèƒ½å·¥ä½œæµç³»ç»Ÿï¼Œæ»¡è¶³å„ç§å¤æ‚çš„ä¸šåŠ¡éœ€æ±‚ã€‚